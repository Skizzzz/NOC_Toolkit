{% extends "base.html" %}
{% block title %}SolarWinds Nodes{% endblock %}
{% block head_extra %}
<style>
  .page-header{
    background: linear-gradient(135deg, rgba(79,70,229,0.1) 0%, rgba(6,182,212,0.1) 100%);
    border:1px solid var(--border);
    border-radius:12px;
    padding:24px;
    margin-bottom:24px;
  }
  .page-header h2{margin:0 0 8px 0; font-size:28px;}
  .page-header p{margin:0; font-size:15px; line-height:1.5; color:var(--muted);}

  .filter-panel{
    background: color-mix(in oklab, var(--card) 98%, transparent);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
    margin-bottom:20px;
  }
  .filter-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
    gap:16px;
    margin-bottom:16px;
  }
  .filter-panel .field{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .filter-panel label{
    font-size:12px;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:.05em;
    color:var(--muted);
  }
  .filter-panel input{
    padding:10px 12px;
    border-radius:8px;
    border:1px solid var(--border);
    background: color-mix(in oklab, var(--card) 96%, transparent);
    transition: all 0.2s ease;
  }
  .filter-panel input:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 15%, transparent);
  }

  .stats-row{
    display:flex;
    gap:16px;
    align-items:center;
    padding:12px 0;
    border-top:1px solid var(--border);
  }
  .stats-row .stat{
    display:flex;
    align-items:center;
    gap:8px;
    font-size:13px;
  }
  .stats-row .stat svg{
    width:16px;
    height:16px;
    color:var(--accent);
  }
  .stats-row .stat-value{
    font-weight:700;
    color:var(--accent);
  }

  .table-container{
    background: color-mix(in oklab, var(--card) 98%, transparent);
    border:1px solid var(--border);
    border-radius:12px;
    overflow:hidden;
    margin-bottom:20px;
  }
  .nodes-table{
    width:100%;
    border-collapse:collapse;
  }
  .nodes-table th{
    text-align:left;
    padding:14px 16px;
    background: color-mix(in oklab, var(--card) 94%, transparent);
    border-bottom:2px solid var(--border);
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:.05em;
    color:var(--muted);
    font-weight:600;
    position:sticky;
    top:0;
    z-index:1;
  }
  .nodes-table td{
    padding:14px 16px;
    border-bottom:1px solid var(--border);
    font-size:14px;
  }
  .nodes-table tbody tr{
    transition: background 0.15s ease;
  }
  .nodes-table tbody tr:hover{
    background: color-mix(in oklab, var(--accent) 4%, transparent);
  }
  .nodes-table tbody tr:last-child td{
    border-bottom:none;
  }
  .node-name{
    font-weight:600;
    color:var(--accent);
  }

  .pagination{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:16px;
    background: color-mix(in oklab, var(--card) 98%, transparent);
    border:1px solid var(--border);
    border-radius:12px;
    gap:12px;
    flex-wrap:wrap;
  }
  .pagination .page-info{
    font-size:13px;
    color:var(--muted);
    font-weight:600;
  }
  .pagination .page-controls{
    display:flex;
    gap:8px;
  }
  .pagination .btn{
    padding:8px 16px;
    font-size:13px;
  }

  .info-banner{
    display:flex;
    align-items:flex-start;
    gap:12px;
    padding:14px 16px;
    background: color-mix(in oklab, var(--info) 8%, transparent);
    border:1px solid color-mix(in oklab, var(--info) 20%, transparent);
    border-radius:10px;
    margin-top:16px;
  }
  .info-banner svg{
    width:20px;
    height:20px;
    color:var(--info);
    flex-shrink:0;
    margin-top:2px;
  }
  .info-banner-content{
    flex:1;
    font-size:13px;
    line-height:1.5;
    color:var(--muted);
  }
  .info-banner-content strong{
    color:var(--info);
    font-weight:600;
  }
</style>
{% endblock %}
{% block content %}
  <nav class="breadcrumbs">
    <a href="{{ url_for('index') }}">Dashboard</a>
    <span class="breadcrumbs-separator">/</span>
    <span class="breadcrumbs-current">SolarWinds Nodes</span>
  </nav>

  <div class="nav-pills" style="display:flex; gap:8px; margin-bottom:24px;">
    <a href="{{ url_for('solarwinds_nodes') }}" style="padding:10px 18px; border-radius:8px; font-size:13px; font-weight:600; text-decoration:none; background:var(--accent); color:#fff; border:1px solid var(--accent);">Nodes</a>
    <a href="{{ url_for('solarwinds_inventory') }}" style="padding:10px 18px; border-radius:8px; font-size:13px; font-weight:600; text-decoration:none; color:var(--text); background:var(--card); border:1px solid var(--border); transition:all 0.2s ease;">Inventory</a>
    <a href="{{ url_for('solarwinds_nodes_settings') }}" style="padding:10px 18px; border-radius:8px; font-size:13px; font-weight:600; text-decoration:none; color:var(--text); background:var(--card); border:1px solid var(--border); transition:all 0.2s ease;">Settings</a>
  </div>

  <div class="page-header">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:20px; flex-wrap:wrap;">
      <div style="flex:1;">
        <h2>SolarWinds Network Inventory</h2>
        <p>Live inventory synchronized from Orion NPM. Filter by hostname, IP address, organization, vendor, model, or firmware version to quickly locate network devices.</p>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn" href="{{ url_for('solarwinds_nodes_settings') }}">
          <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="margin-right:4px;">
            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"/>
          </svg>
          Settings
        </a>
        <a class="btn" href="{{ url_for('changes_list') }}">
          <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="margin-right:4px;">
            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"/>
          </svg>
          Changes
        </a>
      </div>
    </div>
  </div>

  <div class="filter-panel">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:16px;">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" style="color:var(--accent);">
        <path d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z"/>
      </svg>
      <h3 style="margin:0; font-size:16px; font-weight:600;">Filter Devices</h3>
    </div>

    <div class="filter-grid">
      <div class="field">
        <label for="filterCaption">Hostname</label>
        <input id="filterCaption" type="text" placeholder="Search hostname..." />
      </div>
      <div class="field">
        <label for="filterIp">IP Address</label>
        <input id="filterIp" type="text" placeholder="Search IP..." />
      </div>
      <div class="field">
        <label for="filterOrg">Organization</label>
        <input id="filterOrg" type="text" placeholder="Search organization..." />
      </div>
      <div class="field">
        <label for="filterVendor">Vendor</label>
        <input id="filterVendor" type="text" placeholder="Search vendor..." />
      </div>
      <div class="field">
        <label for="filterModel">Model</label>
        <input id="filterModel" type="text" placeholder="Search model..." />
      </div>
      <div class="field">
        <label for="filterVersion">Version</label>
        <input id="filterVersion" type="text" placeholder="Search version..." />
      </div>
    </div>

    <div class="stats-row">
      <div class="stat">
        <svg viewBox="0 0 20 20" fill="currentColor">
          <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
        </svg>
        <span>Showing <span class="stat-value" id="nodeCount">{{ nodes|length }}</span> of <span class="stat-value">{{ nodes|length }}</span> nodes</span>
      </div>
      <div class="stat" style="margin-left:auto; font-size:12px;">
        <svg viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"/>
        </svg>
        <span>Last poll: {{ settings.last_poll_ts or 'never' }}</span>
      </div>
    </div>

    {% if settings.last_poll_status and settings.last_poll_status != 'never' %}
      <div class="info-banner">
        <svg viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"/>
        </svg>
        <div class="info-banner-content">
          <strong>{{ settings.last_poll_status }}</strong> — {{ settings.last_poll_message or 'Inventory synced successfully' }}
        </div>
      </div>
    {% endif %}
  </div>

  <div class="table-container">
    {% if nodes %}
      <table class="nodes-table">
        <thead>
          <tr>
            <th>Hostname</th>
            <th>IP Address</th>
            <th>Organization</th>
            <th>Vendor</th>
            <th>Model</th>
            <th>Version</th>
          </tr>
        </thead>
        <tbody id="nodesBody"></tbody>
      </table>
    {% else %}
      <div style="padding:40px; text-align:center;">
        <svg width="48" height="48" viewBox="0 0 20 20" fill="currentColor" style="margin:0 auto 16px; color:var(--muted); opacity:0.5;">
          <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
        </svg>
        <p class="muted" style="font-size:15px;">No nodes available. Configure credentials and run a poll from settings.</p>
        <a class="btn primary" href="{{ url_for('solarwinds_nodes_settings') }}" style="margin-top:12px;">
          <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="margin-right:4px;">
            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"/>
          </svg>
          Go to Settings
        </a>
      </div>
    {% endif %}
  </div>

  {% if nodes %}
    <div class="pagination" id="paginationControls"></div>
  {% endif %}

<script>
(function(){
  const rowsData = {{ nodes|tojson|safe }};
  const body = document.getElementById('nodesBody');
  const filters = {
    caption: document.getElementById('filterCaption'),
    ip_address: document.getElementById('filterIp'),
    organization: document.getElementById('filterOrg'),
    vendor: document.getElementById('filterVendor'),
    model: document.getElementById('filterModel'),
    version: document.getElementById('filterVersion'),
  };
  const countEl = document.getElementById('nodeCount');
  const pagination = document.getElementById('paginationControls');
  const PAGE_SIZE = 100;
  if (!body || !Array.isArray(rowsData)) return;

  let filteredData = rowsData.slice();
  let currentPage = 1;

  const renderPagination = () => {
    const totalPages = Math.max(1, Math.ceil(filteredData.length / PAGE_SIZE));
    if (currentPage > totalPages) currentPage = totalPages;
    if (!pagination) return;
    pagination.innerHTML = '';

    const info = document.createElement('span');
    info.className = 'page-info';
    const start = (currentPage - 1) * PAGE_SIZE + 1;
    const end = Math.min(currentPage * PAGE_SIZE, filteredData.length);
    info.textContent = filteredData.length === 0 ? 'No results' : `Showing ${start}-${end} of ${filteredData.length}`;

    const controls = document.createElement('div');
    controls.className = 'page-controls';

    const makeButton = (label, disabled, handler) => {
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.type = 'button';
      btn.textContent = label;
      btn.disabled = disabled;
      btn.addEventListener('click', handler);
      return btn;
    };

    controls.appendChild(makeButton('Previous', currentPage <= 1, () => {
      if (currentPage > 1) {
        currentPage -= 1;
        renderRows();
      }
    }));
    controls.appendChild(makeButton('Next', currentPage >= totalPages, () => {
      if (currentPage < totalPages) {
        currentPage += 1;
        renderRows();
      }
    }));

    pagination.appendChild(info);
    pagination.appendChild(controls);
  };

  const renderRows = () => {
    body.innerHTML = '';
    const totalPages = Math.max(1, Math.ceil(filteredData.length / PAGE_SIZE));
    if (currentPage > totalPages) currentPage = totalPages;
    const start = (currentPage - 1) * PAGE_SIZE;
    filteredData.slice(start, start + PAGE_SIZE).forEach(node => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span class="node-name">${node.caption || '—'}</span></td>
        <td>${node.ip_address || '—'}</td>
        <td>${node.organization || '—'}</td>
        <td>${node.vendor || '—'}</td>
        <td>${node.model || '—'}</td>
        <td>${node.version || '—'}</td>
      `;
      body.appendChild(tr);
    });
    if (countEl) {
      countEl.textContent = filteredData.length;
    }
    renderPagination();
  };

  const applyFilters = () => {
    const active = Object.entries(filters)
      .map(([key, input]) => ({ key, value: (input?.value || '').trim().toLowerCase() }))
      .filter(entry => entry.value);

    filteredData = rowsData.filter(node => {
      return active.every(({key, value}) => ((node[key] || '').toLowerCase().includes(value)));
    });
    currentPage = 1;
    renderRows();
  };

  Object.values(filters).forEach(input => input && input.addEventListener('input', applyFilters));
  applyFilters();
})();
</script>
{% endblock %}
