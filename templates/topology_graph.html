{% extends "base.html" %}
{% block title %}Network Topology Graph{% endblock %}
{% block head_extra %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
<script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.min.js"></script>
<style>
  .page-header{
    background: linear-gradient(135deg, rgba(79,70,229,0.1) 0%, rgba(6,182,212,0.1) 100%);
    border:1px solid var(--border);
    border-radius:12px;
    padding:24px;
    margin-bottom:24px;
  }
  .page-header h2{margin:0 0 8px 0; font-size:28px;}
  .page-header p{margin:0; font-size:15px; line-height:1.5; color:var(--muted);}

  .topology-container{
    display:grid;
    grid-template-columns: 300px 1fr;
    gap:20px;
    height:calc(100vh - 250px);
    min-height:600px;
  }

  .sidebar-panel{
    background: color-mix(in oklab, var(--card) 98%, transparent);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
    overflow-y:auto;
  }

  .graph-panel{
    background: color-mix(in oklab, var(--card) 98%, transparent);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
    position:relative;
  }

  #cy{
    width:100%;
    height:100%;
    background: color-mix(in oklab, var(--card) 94%, transparent);
    border-radius:8px;
  }

  .view-toggle{
    display:flex;
    gap:8px;
    margin-bottom:16px;
  }

  .view-btn{
    flex:1;
    padding:10px 16px;
    background:transparent;
    border:1px solid var(--border);
    border-radius:8px;
    color:var(--text);
    font-size:14px;
    font-weight:600;
    cursor:pointer;
    transition: all 0.2s ease;
  }

  .view-btn:hover{
    background: color-mix(in oklab, var(--accent) 10%, transparent);
    border-color:var(--accent);
  }

  .view-btn.active{
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color:white;
    border-color:transparent;
  }

  .controls-section{
    margin-bottom:20px;
  }

  .controls-section h4{
    margin:0 0 12px 0;
    font-size:14px;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:0.05em;
  }

  .control-item{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 0;
    border-bottom:1px solid var(--border);
  }

  .control-item:last-child{
    border-bottom:none;
  }

  .control-label{
    font-size:13px;
    color:var(--text);
  }

  .control-btn{
    padding:6px 12px;
    background:transparent;
    border:1px solid var(--border);
    border-radius:6px;
    color:var(--text);
    font-size:12px;
    cursor:pointer;
    transition: all 0.2s ease;
  }

  .control-btn:hover{
    background:var(--accent);
    color:white;
    border-color:var(--accent);
  }

  .node-details{
    margin-top:20px;
    padding:16px;
    background: color-mix(in oklab, var(--card) 94%, transparent);
    border-radius:8px;
    display:none;
  }

  .node-details.active{
    display:block;
  }

  .node-details h4{
    margin:0 0 12px 0;
    font-size:16px;
    color:var(--text);
  }

  .node-detail-item{
    display:flex;
    justify-content:space-between;
    padding:8px 0;
    font-size:13px;
    border-bottom:1px solid var(--border);
  }

  .node-detail-item:last-child{
    border-bottom:none;
  }

  .node-detail-label{
    color:var(--muted);
    font-weight:600;
  }

  .node-detail-value{
    color:var(--text);
    text-align:right;
  }

  .expand-btn{
    width:100%;
    margin-top:12px;
    padding:10px;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color:white;
    border:none;
    border-radius:8px;
    font-size:13px;
    font-weight:600;
    cursor:pointer;
    transition: all 0.2s ease;
  }

  .expand-btn:hover{
    transform:translateY(-1px);
    box-shadow: 0 4px 12px rgba(79,70,229,0.3);
  }

  .expand-btn:disabled{
    background:var(--border);
    color:var(--muted);
    cursor:not-allowed;
    transform:none;
  }

  .legend{
    margin-top:20px;
    padding:16px;
    background: color-mix(in oklab, var(--card) 94%, transparent);
    border-radius:8px;
  }

  .legend h4{
    margin:0 0 12px 0;
    font-size:14px;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:0.05em;
  }

  .legend-item{
    display:flex;
    align-items:center;
    gap:10px;
    padding:6px 0;
    font-size:13px;
  }

  .legend-color{
    width:16px;
    height:16px;
    border-radius:4px;
  }

  .loading-overlay{
    position:absolute;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:rgba(0,0,0,0.5);
    backdrop-filter:blur(4px);
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:12px;
    z-index:1000;
  }

  .loading-content{
    background:var(--card);
    padding:30px 40px;
    border-radius:12px;
    text-align:center;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  }

  .spinner{
    width:40px;
    height:40px;
    border:4px solid color-mix(in oklab, var(--accent) 20%, transparent);
    border-top-color:var(--accent);
    border-radius:50%;
    animation: spin 0.8s linear infinite;
    margin:0 auto 16px;
  }

  @keyframes spin{
    to{transform:rotate(360deg);}
  }

  .stats-bar{
    display:flex;
    gap:12px;
    margin-bottom:16px;
  }

  .stat-item{
    flex:1;
    padding:12px;
    background: color-mix(in oklab, var(--card) 94%, transparent);
    border-radius:8px;
    text-align:center;
  }

  .stat-value{
    font-size:24px;
    font-weight:700;
    color:var(--accent);
  }

  .stat-label{
    font-size:11px;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:0.05em;
    margin-top:4px;
  }

  .table-view{
    display:none;
    max-height:calc(100vh - 250px);
    overflow-y:auto;
  }

  .table-view.active{
    display:block;
  }

  .neighbors-table{
    width:100%;
    border-collapse:collapse;
  }

  .neighbors-table th{
    text-align:left;
    padding:12px;
    background: color-mix(in oklab, var(--card) 90%, transparent);
    border-bottom:2px solid var(--border);
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:0.05em;
    color:var(--muted);
    font-weight:600;
    position:sticky;
    top:0;
  }

  .neighbors-table td{
    padding:12px;
    border-bottom:1px solid var(--border);
    font-size:14px;
  }

  .neighbors-table tr:hover{
    background: color-mix(in oklab, var(--accent) 4%, transparent);
  }

  .neighbor-ap{
    background: color-mix(in oklab, var(--warning) 3%, transparent);
  }
</style>
{% endblock %}

{% block content %}
  <nav class="breadcrumbs">
    <a href="{{ url_for('index') }}">Dashboard</a>
    <span class="breadcrumbs-separator">/</span>
    <a href="{{ url_for('topology_tool') }}">Topology Builder</a>
    <span class="breadcrumbs-separator">/</span>
    <span class="breadcrumbs-current">Interactive Graph</span>
  </nav>

  <div class="page-header">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:20px; flex-wrap:wrap;">
      <div style="flex:1;">
        <h2>Interactive Network Topology</h2>
        <p>Explore network topology with an interactive graph. Click nodes to view details and expand neighbors dynamically.</p>
      </div>
      <div style="display:flex; gap:10px;">
        <a href="{{ url_for('topology_tool') }}" class="btn">
          <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="margin-right:6px;">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
          </svg>
          Back to Builder
        </a>
      </div>
    </div>
  </div>

  <div class="view-toggle">
    <button class="view-btn active" data-view="graph">
      <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="margin-right:6px; vertical-align:middle;">
        <circle cx="5" cy="5" r="2"/><circle cx="15" cy="5" r="2"/><circle cx="10" cy="15" r="2"/>
        <path d="M7 6l6 0M6 7l3 6M14 7l-3 6" stroke="currentColor" stroke-width="2" fill="none"/>
      </svg>
      Graph View
    </button>
    <button class="view-btn" data-view="table">
      <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="margin-right:6px; vertical-align:middle;">
        <path d="M3 4h14M3 10h14M3 16h14" stroke="currentColor" stroke-width="2" fill="none"/>
      </svg>
      Table View
    </button>
  </div>

  <div class="topology-container">
    <div class="sidebar-panel">
      <div class="controls-section">
        <h4>Graph Controls</h4>
        <div class="control-item">
          <span class="control-label">Fit to View</span>
          <button class="control-btn" onclick="fitGraph()">Fit</button>
        </div>
        <div class="control-item">
          <span class="control-label">Reset Zoom</span>
          <button class="control-btn" onclick="resetZoom()">Reset</button>
        </div>
        <div class="control-item">
          <span class="control-label">Layout</span>
          <button class="control-btn" onclick="relayout()">Refresh</button>
        </div>
        <div class="control-item">
          <span class="control-label">Center Selected</span>
          <button class="control-btn" onclick="centerSelected()">Center</button>
        </div>
      </div>

      <div class="stats-bar" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
        <div class="stat-item">
          <div class="stat-value" id="nodeCount">0</div>
          <div class="stat-label">Nodes</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="edgeCount">0</div>
          <div class="stat-label">Links</div>
        </div>
      </div>

      <div class="node-details" id="nodeDetails">
        <h4 id="nodeTitle">Select a node</h4>
        <div id="nodeInfo"></div>
        <button class="expand-btn" id="expandBtn" onclick="expandNode()" disabled>
          <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="margin-right:6px; vertical-align:middle;">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
          </svg>
          Discover Neighbors
        </button>
      </div>

      <div class="legend">
        <h4>Legend</h4>
        <div class="legend-item">
          <div class="legend-color" style="background:#4f46e5;"></div>
          <span>Root Device</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background:#10b981;"></div>
          <span>Network Device</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background:#94a3b8;"></div>
          <span>Expanded Node</span>
        </div>
      </div>
    </div>

    <div class="graph-panel">
      <div id="cy"></div>
      <div class="loading-overlay" id="loadingOverlay" style="display:none;">
        <div class="loading-content">
          <div class="spinner"></div>
          <p style="margin:0; font-size:14px; color:var(--text); font-weight:600;">Discovering neighbors...</p>
        </div>
      </div>
    </div>
  </div>

  <div class="table-view" id="tableView">
    <div class="topology-results" style="background: color-mix(in oklab, var(--card) 98%, transparent); border:1px solid var(--border); border-radius:12px; padding:24px;">
      <table class="neighbors-table">
        <thead>
          <tr>
            <th>Source Device</th>
            <th>Local Port</th>
            <th>Neighbor Device</th>
            <th>Neighbor IP</th>
            <th>Neighbor Port</th>
            <th>Protocol</th>
          </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
      </table>
    </div>
  </div>

  <script>
  let cy;
  let graphData = { nodes: [], edges: [] };
  let selectedNode = null;
  let expandedNodes = new Set();
  const credentials = {
    username: '{{ username }}',
    password: '{{ password }}',
    secret: '{{ secret }}',
    vendor_mode: '{{ vendor_mode }}'
  };

  // Initialize graph with initial data
  const initialData = {{ initial_data|tojson|safe }};

  // Hierarchy detection based on device naming
  function detectHierarchyLevel(deviceName) {
    const name = (deviceName || '').toLowerCase();

    // Define hierarchy levels (0 = top, 5 = bottom)
    // Use word boundaries to avoid false positives like "cascade" matching "cs"
    if (/\b(cs|core)\b/.test(name)) return 0;
    if (/\bmor\b/.test(name)) return 1;
    if (/\b(tor|top-of-rack)\b/.test(name)) return 2;
    if (/\b(ds|dist|distribution)\b/.test(name)) return 3;
    if (/\b(ag|agg|aggregation)\b/.test(name)) return 4;
    if (/\b(as|access)\b/.test(name)) return 5;

    // Default to middle level if unknown
    return 3;
  }

  // Check if device is an Access Point
  function isAccessPoint(deviceName) {
    const name = (deviceName || '').toUpperCase();
    return name.startsWith('AP') || name.startsWith('AP-');
  }

  function initGraph() {
    cy = cytoscape({
      container: document.getElementById('cy'),
      style: [
        {
          selector: 'node',
          style: {
            'label': 'data(label)',
            'text-valign': 'center',
            'text-halign': 'center',
            'background-color': 'data(color)',
            'width': 'data(size)',
            'height': 'data(size)',
            'font-size': '12px',
            'color': '#1f2937',
            'text-outline-width': 2,
            'text-outline-color': '#fff',
            'border-width': 2,
            'border-color': '#fff',
            'overlay-padding': '6px'
          }
        },
        {
          selector: 'node:selected',
          style: {
            'border-width': 4,
            'border-color': '#4f46e5',
            'overlay-opacity': 0.3,
            'overlay-color': '#4f46e5'
          }
        },
        {
          selector: 'edge',
          style: {
            'width': 2,
            'line-color': '#cbd5e1',
            'target-arrow-color': '#cbd5e1',
            'target-arrow-shape': 'triangle',
            'curve-style': 'bezier',
            'label': 'data(label)',
            'font-size': '10px',
            'text-rotation': 'autorotate',
            'text-margin-y': -10,
            'color': '#64748b'
          }
        },
        {
          selector: 'edge:selected',
          style: {
            'line-color': '#4f46e5',
            'target-arrow-color': '#4f46e5',
            'width': 3
          }
        }
      ],
      layout: {
        name: 'dagre',
        rankDir: 'TB', // Top to bottom
        animate: true,
        animationDuration: 500,
        fit: true,
        padding: 50,
        spacingFactor: 1.5,
        nodeSep: 100,
        edgeSep: 50,
        rankSep: 150
      }
    });

    // Load initial data
    if (initialData && initialData.root) {
      addDevice(initialData.root, initialData.neighbors, true);
    }

    // Node click handler
    cy.on('tap', 'node', function(evt){
      const node = evt.target;
      selectNode(node.data());
    });

    // Update stats
    updateStats();
  }

  function addDevice(device, neighbors, isRoot = false) {
    const deviceId = device.ip_address || device.caption;
    const nodeColor = isRoot ? '#4f46e5' : (expandedNodes.has(deviceId) ? '#94a3b8' : '#10b981');
    const deviceHierarchy = detectHierarchyLevel(device.caption || deviceId);

    // Add root node if not exists
    if (cy.getElementById(deviceId).length === 0) {
      cy.add({
        group: 'nodes',
        data: {
          id: deviceId,
          label: device.caption || deviceId,
          color: nodeColor,
          size: isRoot ? 60 : 40,
          device: device,
          isRoot: isRoot,
          hierarchyLevel: deviceHierarchy
        }
      });
    }

    // Filter out Access Points from neighbors
    const filteredNeighbors = neighbors.filter(neighbor => {
      const neighborName = neighbor.remote_name || '';
      return !isAccessPoint(neighborName);
    });

    // Add neighbors (APs are now filtered out)
    filteredNeighbors.forEach(neighbor => {
      const neighborId = neighbor.remote_ip || neighbor.remote_name;
      const neighborHierarchy = detectHierarchyLevel(neighbor.remote_name);

      // Add neighbor node if not exists
      if (cy.getElementById(neighborId).length === 0) {
        cy.add({
          group: 'nodes',
          data: {
            id: neighborId,
            label: neighbor.remote_name || neighborId,
            color: '#10b981',
            size: 40,
            device: {
              caption: neighbor.remote_name,
              ip_address: neighbor.remote_ip,
              vendor: neighbor.remote_vendor,
              platform: neighbor.remote_platform
            },
            hierarchyLevel: neighborHierarchy
          }
        });
      }

      // Add edge
      const edgeId = deviceId + '-' + neighborId;
      if (cy.getElementById(edgeId).length === 0) {
        cy.add({
          group: 'edges',
          data: {
            id: edgeId,
            source: deviceId,
            target: neighborId,
            label: neighbor.local_interface
          }
        });
      }

      // Update table
      addToTable(device.caption || deviceId, neighbor);
    });

    // Relayout using dagre for hierarchical top-down layout
    cy.layout({
      name: 'dagre',
      rankDir: 'TB',
      animate: true,
      animationDuration: 500,
      fit: true,
      padding: 50,
      spacingFactor: 1.5,
      nodeSep: 100,
      edgeSep: 50,
      rankSep: 150
    }).run();

    updateStats();
  }

  function selectNode(nodeData) {
    selectedNode = nodeData;
    const details = document.getElementById('nodeDetails');
    const title = document.getElementById('nodeTitle');
    const info = document.getElementById('nodeInfo');
    const expandBtn = document.getElementById('expandBtn');

    details.classList.add('active');
    title.textContent = nodeData.label;

    const device = nodeData.device || {};
    let html = '';
    if (device.ip_address) {
      html += `<div class="node-detail-item"><span class="node-detail-label">IP Address</span><span class="node-detail-value">${device.ip_address}</span></div>`;
    }
    if (device.vendor) {
      html += `<div class="node-detail-item"><span class="node-detail-label">Vendor</span><span class="node-detail-value">${device.vendor}</span></div>`;
    }
    if (device.platform) {
      html += `<div class="node-detail-item"><span class="node-detail-label">Platform</span><span class="node-detail-value">${device.platform}</span></div>`;
    }
    if (device.model) {
      html += `<div class="node-detail-item"><span class="node-detail-label">Model</span><span class="node-detail-value">${device.model}</span></div>`;
    }

    info.innerHTML = html;

    // Enable expand button if has IP and not already expanded
    const canExpand = device.ip_address && !expandedNodes.has(nodeData.id);
    expandBtn.disabled = !canExpand;
  }

  async function expandNode() {
    if (!selectedNode || !selectedNode.device || !selectedNode.device.ip_address) return;

    const deviceId = selectedNode.id;
    if (expandedNodes.has(deviceId)) {
      alert('This node has already been expanded');
      return;
    }

    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = 'flex';

    try {
      const response = await fetch('/api/topology/discover', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          target: selectedNode.device.ip_address,
          username: credentials.username,
          password: credentials.password,
          secret: credentials.secret,
          vendor_mode: credentials.vendor_mode
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to discover neighbors');
      }

      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || 'Discovery failed');
      }

      // Mark this node as expanded
      expandedNodes.add(deviceId);
      const node = cy.getElementById(deviceId);
      node.data('color', '#94a3b8');

      // Filter out Access Points from neighbors
      const filteredNeighbors = data.neighbors.filter(neighbor => {
        const neighborName = neighbor.remote_name || '';
        return !isAccessPoint(neighborName);
      });

      // Add each neighbor as a new node and connect to the expanded device
      let nodesAdded = 0;
      let edgesAdded = 0;

      filteredNeighbors.forEach((neighbor, index) => {
        const neighborId = neighbor.remote_ip || neighbor.remote_name;
        if (!neighborId) {
          return;
        }

        const neighborHierarchy = detectHierarchyLevel(neighbor.remote_name);

        try {
          // Check if node exists
          const existingNode = cy.getElementById(neighborId);
          if (existingNode.length === 0) {
            // Add new node
            const newNode = cy.add({
              group: 'nodes',
              data: {
                id: neighborId,
                label: neighbor.remote_name || neighborId,
                color: '#10b981',
                size: 40,
                device: {
                  caption: neighbor.remote_name,
                  ip_address: neighbor.remote_ip,
                  vendor: neighbor.remote_vendor,
                  platform: neighbor.remote_platform
                },
                hierarchyLevel: neighborHierarchy
              }
            });
            nodesAdded++;
          }

          // Add edge from expanded device to neighbor
          const edgeId = deviceId + '-' + neighborId;
          const existingEdge = cy.getElementById(edgeId);
          if (existingEdge.length === 0) {
            const newEdge = cy.add({
              group: 'edges',
              data: {
                id: edgeId,
                source: deviceId,
                target: neighborId,
                label: neighbor.local_interface || ''
              }
            });
            edgesAdded++;
          }
        } catch (err) {
          // Silently handle error
        }

        // Update table
        addToTable(selectedNode.label || deviceId, neighbor);
      });

      // Force Cytoscape to update
      if (nodesAdded > 0 || edgesAdded > 0) {
        const layout = cy.layout({
          name: 'dagre',
          rankDir: 'TB',
          animate: true,
          animationDuration: 1000,
          fit: true,
          padding: 50,
          spacingFactor: 1.5,
          nodeSep: 100,
          edgeSep: 50,
          rankSep: 150
        });

        layout.run();

        // Force viewport update after layout
        layout.on('layoutstop', function() {
          cy.fit(null, 50);
          updateStats();
        });
      } else {
        updateStats();
      }

      // Show success message
      const message = filteredNeighbors.length === 0
        ? 'No network devices discovered (APs excluded)'
        : `Discovered ${filteredNeighbors.length} network device${filteredNeighbors.length === 1 ? '' : 's'}!`;

      // Toast notification (simple version)
      const toast = document.createElement('div');
      toast.style.cssText = 'position:fixed; top:20px; right:20px; background:#10b981; color:white; padding:16px 24px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:10000; font-weight:600;';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);

      // Update expand button state
      document.getElementById('expandBtn').disabled = true;

    } catch (error) {
      // Error toast
      const toast = document.createElement('div');
      toast.style.cssText = 'position:fixed; top:20px; right:20px; background:#ef4444; color:white; padding:16px 24px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:10000; font-weight:600;';
      toast.textContent = 'Error: ' + error.message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    } finally {
      overlay.style.display = 'none';
    }
  }

  function addToTable(source, neighbor) {
    const tbody = document.getElementById('tableBody');
    const isAP = (neighbor.remote_name || '').toUpperCase().startsWith('AP');
    const row = tbody.insertRow();
    row.className = isAP ? 'neighbor-ap' : '';

    row.insertCell(0).textContent = source;
    row.insertCell(1).textContent = neighbor.local_interface || '—';
    row.insertCell(2).textContent = neighbor.remote_name || '—';
    row.insertCell(3).textContent = neighbor.remote_ip || '—';
    row.insertCell(4).textContent = neighbor.remote_port || '—';
    row.insertCell(5).textContent = (neighbor.protocols || []).join('/') || '—';
  }

  function updateStats() {
    document.getElementById('nodeCount').textContent = cy.nodes().length;
    document.getElementById('edgeCount').textContent = cy.edges().length;
  }

  function fitGraph() {
    cy.fit(null, 50);
  }

  function resetZoom() {
    cy.zoom(1);
    cy.center();
  }

  function relayout() {
    cy.layout({
      name: 'cose',
      animate: true,
      animationDuration: 500,
      fit: true,
      padding: 30
    }).run();
  }

  function centerSelected() {
    if (selectedNode) {
      const node = cy.getElementById(selectedNode.id);
      cy.center(node);
      cy.zoom(2);
    }
  }


  // View toggle
  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const view = btn.dataset.view;
      document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      if (view === 'graph') {
        document.querySelector('.topology-container').style.display = 'grid';
        document.getElementById('tableView').classList.remove('active');
      } else {
        document.querySelector('.topology-container').style.display = 'none';
        document.getElementById('tableView').classList.add('active');
      }
    });
  });

  // Initialize on load
  document.addEventListener('DOMContentLoaded', function() {
    // Register dagre extension with Cytoscape
    if (typeof cytoscape !== 'undefined' && typeof dagre !== 'undefined') {
      cytoscape.use(cytoscapeDagre);
    }
    initGraph();
  });
  </script>
{% endblock %}
