{% extends "base.html" %}
{% block title %}Bulk SSH Results{% endblock %}
{% block head_extra %}
<style>
  .page-header{
    background: linear-gradient(135deg, rgba(79,70,229,0.1) 0%, rgba(6,182,212,0.1) 100%);
    border:1px solid var(--border);
    border-radius:12px;
    padding:24px;
    margin-bottom:24px;
  }
  .page-header h2{margin:0 0 8px 0; font-size:28px;}
  .page-header p{margin:0; font-size:15px; line-height:1.5; color:var(--muted);}

  .progress-section{
    background: color-mix(in oklab, var(--card) 98%, transparent);
    border:1px solid var(--border);
    border-radius:12px;
    padding:24px;
    margin-bottom:20px;
  }

  .progress-stats{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap:16px;
    margin-bottom:20px;
  }
  .progress-stat{
    background: color-mix(in oklab, var(--card) 94%, transparent);
    border:1px solid var(--border);
    border-radius:10px;
    padding:16px;
    text-align:center;
  }
  .progress-stat-value{
    font-size:32px;
    font-weight:700;
    line-height:1;
    margin-bottom:6px;
  }
  .progress-stat-label{
    font-size:13px;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:0.05em;
  }
  .stat-total{ color:var(--accent); }
  .stat-completed{ color:var(--info); }
  .stat-success{ color:var(--success); }
  .stat-failed{ color:var(--error); }

  .progress-bar-container{
    background: color-mix(in oklab, var(--card) 90%, transparent);
    border-radius:999px;
    height:12px;
    overflow:hidden;
    margin-bottom:12px;
  }
  .progress-bar{
    height:100%;
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    transition: width 0.3s ease;
    border-radius:999px;
  }
  .progress-text{
    text-align:center;
    font-size:14px;
    color:var(--muted);
  }

  .status-badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:600;
    text-transform:capitalize;
  }
  .status-running{
    background: color-mix(in oklab, var(--info) 15%, transparent);
    color:var(--info);
  }
  .status-completed{
    background: color-mix(in oklab, var(--success) 15%, transparent);
    color:var(--success);
  }
  .status-completed_with_errors{
    background: color-mix(in oklab, var(--warning) 15%, transparent);
    color:var(--warning);
  }

  .results-container{
    background: color-mix(in oklab, var(--card) 98%, transparent);
    border:1px solid var(--border);
    border-radius:12px;
    overflow:hidden;
  }
  .results-header{
    padding:16px 20px;
    background: color-mix(in oklab, var(--card) 94%, transparent);
    border-bottom:2px solid var(--border);
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:12px;
  }
  .results-header h3{
    margin:0;
    font-size:16px;
    font-weight:600;
  }
  .results-filter{
    display:flex;
    gap:8px;
  }
  .filter-btn{
    padding:6px 12px;
    border:1px solid var(--border);
    border-radius:6px;
    background:transparent;
    color:var(--text);
    font-size:13px;
    cursor:pointer;
    transition: all 0.15s ease;
  }
  .filter-btn:hover{
    background: color-mix(in oklab, var(--accent) 10%, transparent);
    border-color:var(--accent);
  }
  .filter-btn.active{
    background:var(--accent);
    color:white;
    border-color:var(--accent);
  }

  .results-list{
    max-height:600px;
    overflow-y:auto;
  }
  .result-item{
    border-bottom:1px solid var(--border);
    transition: background 0.15s ease;
  }
  .result-item:last-child{
    border-bottom:none;
  }
  .result-item:hover{
    background: color-mix(in oklab, var(--accent) 4%, transparent);
  }
  .result-header{
    padding:14px 20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    cursor:pointer;
    gap:12px;
  }
  .result-device{
    font-weight:600;
    font-size:14px;
    color:var(--text);
    flex:1;
  }
  .result-meta{
    display:flex;
    align-items:center;
    gap:12px;
    font-size:13px;
    color:var(--muted);
  }
  .result-status{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:600;
  }
  .result-status.success{
    background: color-mix(in oklab, var(--success) 15%, transparent);
    color:var(--success);
  }
  .result-status.failed{
    background: color-mix(in oklab, var(--error) 15%, transparent);
    color:var(--error);
  }
  .result-chevron{
    transition: transform 0.2s ease;
    color:var(--muted);
  }
  .result-item.expanded .result-chevron{
    transform: rotate(90deg);
  }

  .result-body{
    display:none;
    padding:0 20px 20px 20px;
    background: color-mix(in oklab, var(--card) 96%, transparent);
  }
  .result-item.expanded .result-body{
    display:block;
  }
  .result-output{
    background: color-mix(in oklab, var(--card) 90%, transparent);
    border:1px solid var(--border);
    border-radius:8px;
    padding:16px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size:13px;
    line-height:1.6;
    color:var(--text);
    white-space:pre-wrap;
    word-wrap:break-word;
    max-height:400px;
    overflow-y:auto;
  }
  .result-error{
    background: color-mix(in oklab, var(--error) 10%, transparent);
    border:1px solid var(--error);
    border-radius:8px;
    padding:14px;
    margin-bottom:12px;
    color:var(--error);
    font-size:13px;
    line-height:1.5;
  }

  .action-bar{
    display:flex;
    gap:12px;
    justify-content:space-between;
    padding-top:20px;
  }
  .btn{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:10px 20px;
    border:none;
    border-radius:8px;
    font-size:14px;
    font-weight:500;
    cursor:pointer;
    transition: all 0.15s ease;
    text-decoration:none;
  }
  .btn-primary{
    background:var(--accent);
    color:white;
  }
  .btn-primary:hover{
    background:var(--accent-2);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px color-mix(in oklab, var(--accent) 30%, transparent);
  }
  .btn-secondary{
    background:transparent;
    color:var(--text);
    border:1px solid var(--border);
  }
  .btn-secondary:hover{
    background: color-mix(in oklab, var(--accent) 5%, transparent);
    border-color:var(--accent);
  }

  .spinner{
    display:inline-block;
    width:14px;
    height:14px;
    border:2px solid color-mix(in oklab, var(--info) 30%, transparent);
    border-top-color:var(--info);
    border-radius:50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin{
    to{ transform: rotate(360deg); }
  }
</style>
{% endblock %}
{% block content %}
  <nav class="breadcrumbs">
    <a href="{{ url_for('index') }}">Dashboard</a>
    <span class="breadcrumbs-separator">/</span>
    <a href="{{ url_for('bulk_ssh') }}">Bulk SSH Terminal</a>
    <span class="breadcrumbs-separator">/</span>
    <span class="breadcrumbs-current">Results</span>
  </nav>

  <div class="page-header">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:20px; flex-wrap:wrap;">
      <div style="flex:1;">
        <h2>Bulk SSH Results</h2>
        <p>Job ID: <code>{{ job.job_id }}</code> â€¢ Command: <code>{{ job.command }}</code></p>
      </div>
      <div>
        <span class="status-badge status-{{ job.status }}" id="jobStatusBadge">
          {% if not job.done %}
            <span class="spinner"></span>
          {% endif %}
          {{ job.status }}
        </span>
      </div>
    </div>
  </div>

  <div class="progress-section">
    <div class="progress-stats">
      <div class="progress-stat">
        <div class="progress-stat-value stat-total" id="deviceCountValue">{{ job.device_count }}</div>
        <div class="progress-stat-label">Total Devices</div>
      </div>
      <div class="progress-stat">
        <div class="progress-stat-value stat-completed" id="completedCountValue">{{ job.completed_count }}</div>
        <div class="progress-stat-label">Completed</div>
      </div>
      <div class="progress-stat">
        <div class="progress-stat-value stat-success" id="successCountValue">{{ job.success_count }}</div>
        <div class="progress-stat-label">Success</div>
      </div>
      <div class="progress-stat">
        <div class="progress-stat-value stat-failed" id="failedCountValue">{{ job.failed_count }}</div>
        <div class="progress-stat-label">Failed</div>
      </div>
    </div>

    <div class="progress-bar-container">
      <div class="progress-bar" id="progressBar" style="width:{{ (job.completed_count / job.device_count * 100) if job.device_count > 0 else 0 }}%"></div>
    </div>
    <div class="progress-text" id="progressText">
      {{ job.completed_count }} of {{ job.device_count }} devices completed
    </div>
  </div>

  <div class="results-container">
    <div class="results-header">
      <h3>Device Results</h3>
      <div class="results-filter">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="success">Success</button>
        <button class="filter-btn" data-filter="failed">Failed</button>
      </div>
    </div>
    <div class="results-list" id="resultsList">
      {% if results %}
        {% for result in results %}
          <div class="result-item" data-status="{{ result.status }}">
            <div class="result-header">
              <div class="result-device">{{ result.device }}</div>
              <div class="result-meta">
                <span class="result-status {{ result.status }}">
                  {% if result.status == 'success' %}
                    <svg width="12" height="12" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                  {% else %}
                    <svg width="12" height="12" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                  {% endif %}
                  {{ result.status }}
                </span>
                <span>{{ result.duration_ms }}ms</span>
                <svg class="result-chevron" width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                </svg>
              </div>
            </div>
            <div class="result-body">
              {% if result.error %}
                <div class="result-error">
                  <strong>Error:</strong> {{ result.error }}
                </div>
              {% endif %}
              {% if result.output %}
                <div class="result-output">{{ result.output }}</div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div style="padding:40px; text-align:center; color:var(--muted);">
          <p>No results yet. Waiting for devices to complete...</p>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="action-bar">
    <div>
      <a href="{{ url_for('bulk_ssh') }}" class="btn btn-secondary">
        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
        </svg>
        New Job
      </a>
    </div>
    <div style="display:flex; gap:12px;">
      <button class="btn btn-secondary" onclick="exportResults()">
        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
        Export CSV
      </button>
      <button class="btn btn-primary" onclick="expandAll()">
        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
        </svg>
        Expand All
      </button>
    </div>
  </div>

  <script>
    const jobId = "{{ job.job_id }}";
    const isDone = {{ 'true' if job.done else 'false' }};
    let pollInterval;

    // Toggle result expansion
    document.querySelectorAll('.result-header').forEach(header => {
      header.addEventListener('click', () => {
        header.parentElement.classList.toggle('expanded');
      });
    });

    // Filter results
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const filter = btn.getAttribute('data-filter');

        // Update active button
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Filter items
        document.querySelectorAll('.result-item').forEach(item => {
          const status = item.getAttribute('data-status');
          if (filter === 'all' || status === filter) {
            item.style.display = '';
          } else {
            item.style.display = 'none';
          }
        });
      });
    });

    // Expand all results
    function expandAll() {
      const items = document.querySelectorAll('.result-item');
      const anyExpanded = Array.from(items).some(item => item.classList.contains('expanded'));

      items.forEach(item => {
        if (anyExpanded) {
          item.classList.remove('expanded');
        } else {
          item.classList.add('expanded');
        }
      });
    }

    // Export to CSV
    function exportResults() {
      window.location.href = `/api/bulk-ssh/export/${jobId}`;
    }

    // Poll for updates if job is not done
    async function pollJobStatus() {
      try {
        const response = await fetch(`/api/bulk-ssh/status/${jobId}`);
        const data = await response.json();

        // Update stats
        document.getElementById('completedCountValue').textContent = data.completed_count;
        document.getElementById('successCountValue').textContent = data.success_count;
        document.getElementById('failedCountValue').textContent = data.failed_count;

        // Update progress bar
        const progress = (data.completed_count / data.device_count * 100).toFixed(1);
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressText').textContent =
          `${data.completed_count} of ${data.device_count} devices completed`;

        // Update status badge
        const badge = document.getElementById('jobStatusBadge');
        badge.className = `status-badge status-${data.status}`;
        if (data.done) {
          badge.innerHTML = data.status;
          clearInterval(pollInterval);
          // Reload page to show all results
          setTimeout(() => window.location.reload(), 1000);
        } else {
          badge.innerHTML = `<span class="spinner"></span> ${data.status}`;
        }
      } catch (error) {
        console.error('Error polling job status:', error);
      }
    }

    // Start polling if job is not done
    if (!isDone) {
      pollInterval = setInterval(pollJobStatus, 2000);
    }
  </script>
{% endblock %}
