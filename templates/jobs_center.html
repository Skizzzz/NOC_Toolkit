{% extends "base.html" %}
{% block title %}Jobs Center — NOC Toolkit{% endblock %}
{% block head_extra %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<style>
  .page-header{
    background: linear-gradient(135deg, rgba(79,70,229,0.1) 0%, rgba(6,182,212,0.1) 100%);
    border:1px solid var(--border);
    border-radius:12px;
    padding:24px;
    margin-bottom:24px;
  }
  .page-header h2{margin:0 0 8px 0; font-size:28px;}
  .page-header p{margin:0; font-size:15px; line-height:1.5; color:var(--muted);}

  .jobs-stats{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));
    gap:16px;
    margin-bottom:24px;
  }
  .job-stat{
    background: color-mix(in oklab, var(--card) 98%, transparent);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
    text-align:center;
    transition: all 0.2s ease;
  }
  .job-stat:hover{
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    transform: translateY(-2px);
  }
  .job-stat-icon{
    width:40px;
    height:40px;
    margin:0 auto 12px;
    border-radius:10px;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .job-stat-value{
    font-size:32px;
    font-weight:700;
    line-height:1;
    margin-bottom:8px;
  }
  .job-stat-label{
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:0.05em;
    color:var(--muted);
    font-weight:600;
  }

  .filter-panel{
    background: color-mix(in oklab, var(--card) 98%, transparent);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
    margin-bottom:20px;
  }
  .filter-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
    gap:16px;
  }
  .filter-group{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .filter-group label{
    font-size:12px;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:0.05em;
    color:var(--muted);
  }
  .filter-group select{
    padding:10px 12px;
    border-radius:8px;
    border:1px solid var(--border);
    background: color-mix(in oklab, var(--card) 96%, transparent);
    transition: all 0.2s ease;
  }
  .filter-group select:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 15%, transparent);
  }

  .table-container{
    background: color-mix(in oklab, var(--card) 98%, transparent);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
  }

  /* DataTables overrides */
  .dataTables_wrapper{
    color:var(--text);
  }
  .dataTables_wrapper .dataTables_length select,
  .dataTables_wrapper .dataTables_filter input{
    background: color-mix(in oklab, var(--card) 96%, transparent);
    color:var(--text);
    border:1px solid var(--border);
    border-radius:8px;
    padding:8px 12px;
  }
  .dataTables_wrapper .dataTables_filter input:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 15%, transparent);
  }
  .dataTables_wrapper .dataTables_paginate .paginate_button{
    color:var(--text) !important;
    border:1px solid var(--border);
    background:var(--card);
    border-radius:8px;
    padding:8px 14px;
    margin:0 4px;
    transition: all 0.2s ease;
  }
  .dataTables_wrapper .dataTables_paginate .paginate_button.current{
    background:linear-gradient(135deg, var(--accent), var(--accent-2)) !important;
    color:#fff !important;
    border-color:transparent !important;
    box-shadow: 0 4px 12px rgba(79,70,229,0.3);
  }
  .dataTables_wrapper .dataTables_paginate .paginate_button:hover{
    background:var(--accent) !important;
    color:#fff !important;
    border-color:var(--accent) !important;
  }
  .dataTables_wrapper .dataTables_info,
  .dataTables_wrapper .dataTables_length label,
  .dataTables_wrapper .dataTables_filter label{
    color:var(--muted);
    font-size:13px;
  }
  #jobsTable{
    width:100%;
    border-collapse:collapse;
  }
  #jobsTable thead th{
    text-align:left;
    padding:12px 16px;
    background: color-mix(in oklab, var(--card) 94%, transparent);
    border-bottom:2px solid var(--border);
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:0.05em;
    color:var(--muted);
    font-weight:600;
  }
  #jobsTable tbody td{
    padding:14px 16px;
    border-bottom:1px solid var(--border);
    font-size:14px;
  }
  #jobsTable tbody tr{
    transition: background 0.15s ease;
  }
  #jobsTable tbody tr:hover{
    background: color-mix(in oklab, var(--accent) 4%, transparent);
  }

  .job-actions{
    display:flex;
    gap:8px;
  }
  .btn-sm{
    padding:6px 12px;
    font-size:12px;
    border-radius:6px;
  }
  .progress-bar{
    width:100px;
    height:8px;
    background:var(--border);
    border-radius:4px;
    overflow:hidden;
  }
  .progress-fill{
    height:100%;
    background:linear-gradient(90deg, var(--accent), var(--accent-2));
    transition: width 0.3s ease;
  }
</style>
{% endblock %}
{% block content %}
  <nav class="breadcrumbs">
    <a href="{{ url_for('index') }}">Dashboard</a>
    <span class="breadcrumbs-separator">/</span>
    <span class="breadcrumbs-current">Jobs Center</span>
  </nav>

  <div class="page-header">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:20px; flex-wrap:wrap;">
      <div style="flex:1;">
        <h2>Jobs Center</h2>
        <p>Monitor and manage all background tasks and operations. View real-time progress, logs, and results from configuration changes, polls, and automated workflows.</p>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" onclick="refreshJobs()">
          <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="margin-right:4px;">
            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"/>
          </svg>
          Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="jobs-stats">
    <div class="job-stat">
      <div class="job-stat-icon">
        <svg width="22" height="22" viewBox="0 0 20 20" fill="currentColor">
          <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
          <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z"/>
        </svg>
      </div>
      <div class="job-stat-value" id="totalJobsCount">{{ jobs|length }}</div>
      <div class="job-stat-label">Total Jobs</div>
    </div>
    <div class="job-stat">
      <div class="job-stat-icon" style="background:linear-gradient(135deg, #3b82f6, #06b6d4);">
        <svg width="22" height="22" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/>
        </svg>
      </div>
      <div class="job-stat-value" id="runningJobsCount">0</div>
      <div class="job-stat-label">Running</div>
    </div>
    <div class="job-stat">
      <div class="job-stat-icon" style="background:linear-gradient(135deg, #10b981, #059669);">
        <svg width="22" height="22" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
        </svg>
      </div>
      <div class="job-stat-value" id="completedJobsCount">0</div>
      <div class="job-stat-label">Completed</div>
    </div>
    <div class="job-stat">
      <div class="job-stat-icon" style="background:linear-gradient(135deg, #ef4444, #dc2626);">
        <svg width="22" height="22" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"/>
        </svg>
      </div>
      <div class="job-stat-value" id="failedJobsCount">0</div>
      <div class="job-stat-label">Failed</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filter-panel">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:16px;">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" style="color:var(--accent);">
        <path d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z"/>
      </svg>
      <h3 style="margin:0; font-size:16px; font-weight:600;">Filter Jobs</h3>
    </div>
    <div class="filter-grid">
      <div class="filter-group">
        <label>Status</label>
        <select id="filterStatus">
          <option value="">All Statuses</option>
          <option value="running">Running</option>
          <option value="completed">Completed</option>
          <option value="failed">Failed</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Job Type</label>
        <select id="filterType">
          <option value="">All Types</option>
          <option value="wlc_rf">WLC RF Poll</option>
          <option value="wlc_clients">WLC Clients Poll</option>
          <option value="interface_action">Interface Action</option>
          <option value="global_action">Global Config</option>
          <option value="topology">Topology</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Time Range</label>
        <select id="filterTime">
          <option value="">All Time</option>
          <option value="1h">Last Hour</option>
          <option value="24h" selected>Last 24 Hours</option>
          <option value="7d">Last 7 Days</option>
          <option value="30d">Last 30 Days</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Jobs Table -->
  <div class="table-container">
    <table id="jobsTable" class="display">
      <thead>
        <tr>
          <th>Job ID</th>
          <th>Type</th>
          <th>Description</th>
          <th>Status</th>
          <th>Started</th>
          <th>Duration</th>
          <th>Progress</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for job in jobs %}
        <tr data-job-id="{{ job.id }}" data-status="{{ job.status }}" data-type="{{ job.type }}">
          <td><code style="font-size:11px; font-weight:600; color:var(--accent);">{{ job.id[:8] }}</code></td>
          <td>
            <span class="badge neutral">{{ job.type }}</span>
          </td>
          <td>{{ job.description or '—' }}</td>
          <td>
            {% if job.status == 'running' %}
              <span class="badge info">Running</span>
            {% elif job.status == 'completed' %}
              <span class="badge success">Completed</span>
            {% elif job.status == 'failed' %}
              <span class="badge error">Failed</span>
            {% else %}
              <span class="badge neutral">{{ job.status }}</span>
            {% endif %}
          </td>
          <td data-order="{{ job.created_at }}">{{ job.created_at_formatted }}</td>
          <td>{{ job.duration or '—' }}</td>
          <td>
            {% if job.progress %}
              <div class="progress-bar">
                <div class="progress-fill" style="width:{{ job.progress }}%;"></div>
              </div>
            {% else %}
              —
            {% endif %}
          </td>
          <td>
            <div class="job-actions">
              <a href="/jobs/{{ job.id }}" class="btn btn-sm">
                <svg width="14" height="14" viewBox="0 0 20 20" fill="currentColor" style="margin-right:4px;">
                  <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                  <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
                View
              </a>
              {% if job.status == 'running' %}
                <button class="btn btn-sm" onclick="cancelJob('{{ job.id }}')">
                  <svg width="14" height="14" viewBox="0 0 20 20" fill="currentColor" style="margin-right:4px;">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"/>
                  </svg>
                  Cancel
                </button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
let table;

$(document).ready(function(){
  // Initialize DataTable
  table = $('#jobsTable').DataTable({
    order: [[4, 'desc']], // Sort by Started date, descending
    pageLength: 25,
    language: {
      search: "Search jobs:",
      lengthMenu: "Show _MENU_ jobs per page",
      info: "Showing _START_ to _END_ of _TOTAL_ jobs",
      infoEmpty: "No jobs found",
      infoFiltered: "(filtered from _MAX_ total jobs)"
    }
  });

  // Custom filters
  $('#filterStatus, #filterType, #filterTime').on('change', function(){
    applyFilters();
  });

  // Update stats
  updateStats();

  // Auto-refresh every 30 seconds
  setInterval(refreshJobs, 30000);
});

function applyFilters(){
  const status = $('#filterStatus').val();
  const type = $('#filterType').val();

  table.rows().every(function(){
    const row = this.node();
    const jobStatus = $(row).data('status');
    const jobType = $(row).data('type');

    let show = true;
    if(status && jobStatus !== status) show = false;
    if(type && jobType !== type) show = false;

    $(row).toggle(show);
  });

  table.draw();
  updateStats();
}

function updateStats(){
  const rows = table.rows({search: 'applied'}).nodes();
  let running = 0, completed = 0, failed = 0;

  $(rows).each(function(){
    const status = $(this).data('status');
    if(status === 'running') running++;
    else if(status === 'completed') completed++;
    else if(status === 'failed') failed++;
  });

  $('#totalJobsCount').text(rows.length);
  $('#runningJobsCount').text(running);
  $('#completedJobsCount').text(completed);
  $('#failedJobsCount').text(failed);
}

async function refreshJobs(){
  try {
    const res = await fetch('/api/jobs');
    if(!res.ok) throw new Error('Failed to refresh');
    const data = await res.json();

    // Clear and rebuild table
    table.clear();
    data.jobs.forEach(job => {
      const statusBadge = getStatusBadge(job.status);
      const actions = `
        <div class="job-actions">
          <a href="/jobs/${job.id}" class="btn btn-sm">
            <svg width="14" height="14" viewBox="0 0 20 20" fill="currentColor" style="margin-right:4px;">
              <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
              <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
            View
          </a>
          ${job.status === 'running' ? `<button class="btn btn-sm" onclick="cancelJob('${job.id}')"><svg width="14" height="14" viewBox="0 0 20 20" fill="currentColor" style="margin-right:4px;"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"/></svg>Cancel</button>` : ''}
        </div>
      `;
      const progress = job.progress ? `
        <div class="progress-bar">
          <div class="progress-fill" style="width:${job.progress}%;"></div>
        </div>
      ` : '—';

      // Add row with proper cell content
      const rowNode = table.row.add([
        `<code style="font-size:11px; font-weight:600; color:var(--accent);">${job.id.substring(0, 8)}</code>`,
        `<span class="badge neutral">${job.type}</span>`,
        job.description || '—',
        statusBadge,
        `<span data-order="${job.created_at || ''}">${job.created_at_formatted || '—'}</span>`,
        job.duration || '—',
        progress,
        actions
      ]).node();

      // Add data attributes to the row
      $(rowNode).attr('data-job-id', job.id);
      $(rowNode).attr('data-status', job.status);
      $(rowNode).attr('data-type', job.type);
    });
    table.draw();
    updateStats();
    window.showToast && window.showToast('Refreshed', 'Jobs list updated', 'success', 3000);
  } catch(err){
    console.error('Refresh failed:', err);
    window.showToast && window.showToast('Error', 'Failed to refresh jobs', 'error');
  }
}

function getStatusBadge(status){
  const badges = {
    running: '<span class="badge info">Running</span>',
    completed: '<span class="badge success">Completed</span>',
    failed: '<span class="badge error">Failed</span>'
  };
  return badges[status] || `<span class="badge neutral">${status}</span>`;
}

async function cancelJob(jobId){
  if(!confirm('Are you sure you want to cancel this job?')) return;

  try {
    const res = await fetch(`/api/jobs/${jobId}/cancel`, {method: 'POST'});
    if(!res.ok) throw new Error('Failed to cancel');

    window.showToast && window.showToast('Cancelled', 'Job cancellation requested', 'success');
    setTimeout(refreshJobs, 1000);
  } catch(err){
    console.error('Cancel failed:', err);
    window.showToast && window.showToast('Error', 'Failed to cancel job', 'error');
  }
}
</script>
{% endblock %}
