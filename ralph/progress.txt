# Ralph Progress Log
Started: Tue Jan 27 18:46:20 CST 2026
---

## Codebase Patterns
- Flask app is monolithic in app.py with routes, use jsonify for JSON responses
- Database is SQLite via tools/db_jobs.py - uses DB_PATH constant
- Environment variables: FLASK_SECRET_KEY, NOC_ENCRYPTION_KEY, NOC_ADMIN_PASSWORD, NOC_TOOLKIT_DB_PATH, NOC_TOOLKIT_DATA_DIR, WLC_DASHBOARD_KEY
- Security functions in tools/security.py - init_security_db(), require_login decorator
- Syntax check: python3 -m py_compile <file>.py
- Requirements layered in requirements/ directory: base.txt -> prod.txt -> dev.txt
- pyproject.toml contains tool configs for black, mypy, pytest, flake8
- New src/ structure: src/blueprints/{domain}/, src/core/, src/models/ - all with __init__.py
- Application factory: src/app.py create_app(config_name) - configs in src/config.py
- Production entry point: wsgi.py calls create_app("production")
- Core utilities in src/core/: database.py, security.py, helpers.py - import via `from src.core import ...`
- Blueprint templates: place in src/blueprints/{name}/templates/{name}/ (nested for Jinja2 namespacing)
- Blueprint registration: update src/app.py _register_blueprints() function
- Security decorators (url_for): use "auth.login" for blueprint-aware redirects

---

## 2026-01-27 18:47 CST - US-001
- What was implemented:
  - Created Dockerfile with Python 3.11-slim base image
  - Created docker-compose.yml with app and postgres services
  - Created .env.example documenting all environment variables
  - Created docker-entrypoint.sh for database initialization
  - Added /health endpoint in app.py returning {"status": "healthy", "service": "noc-toolkit"}
  - Configured PostgreSQL persistence via named volume (postgres-data)
- Files changed:
  - Dockerfile (new)
  - docker-compose.yml (new)
  - .env.example (new)
  - docker-entrypoint.sh (new)
  - app.py (added health endpoint at line 1847)
- **Learnings for future iterations:**
  - Health endpoint added before /login route at line 1847
  - No pyproject.toml or mypy config exists yet - syntax check via py_compile
  - The app currently uses SQLite; PostgreSQL service is ready but migration happens in later stories
  - Non-root user 'appuser' is created in Docker for security
---

## 2026-01-27 19:02 CST - US-002
- What was implemented:
  - Created requirements/base.txt with core dependencies (Flask, netmiko, cryptography, requests)
  - Created requirements/prod.txt extending base.txt with gunicorn>=21.2.0 and psycopg2-binary>=2.9.9
  - Created requirements/dev.txt extending base.txt with pytest, playwright, black, flake8, mypy
  - Updated Dockerfile to use requirements/prod.txt instead of flat requirements.txt
  - Added pyproject.toml with modern Python project configuration (black, mypy, pytest, flake8 settings)
- Files changed:
  - requirements/base.txt (new)
  - requirements/prod.txt (new)
  - requirements/dev.txt (new)
  - Dockerfile (modified - now copies requirements/ directory and uses prod.txt)
  - pyproject.toml (new)
- **Learnings for future iterations:**
  - pyproject.toml now exists with tool configurations for black, mypy, pytest, flake8
  - Requirements are layered: base.txt (core) -> prod.txt (adds production server) -> dev.txt (adds testing tools)
  - Use `-r base.txt` syntax in requirements files to extend base dependencies
  - The original requirements.txt still exists for backward compatibility but Dockerfile now uses requirements/prod.txt
---

## 2026-01-27 19:15 CST - US-003
- What was implemented:
  - Created README.md with project overview, features list, quick start guide, and project structure
  - Created docs/DEPLOYMENT.md with production deployment guide (Docker, nginx, backups, monitoring, troubleshooting)
  - Created docs/DEVELOPMENT.md with local development setup (venv, running, testing, debugging)
  - Created docs/CONTRIBUTING.md with contribution guidelines (code style, PR process, architecture)
  - Created CHANGELOG.md with version history format and initial release notes
- Files changed:
  - README.md (new)
  - docs/DEPLOYMENT.md (new)
  - docs/DEVELOPMENT.md (new)
  - docs/CONTRIBUTING.md (new)
  - CHANGELOG.md (new)
- **Learnings for future iterations:**
  - Existing docs/ directory already had audit-findings.md and production-runbook.md from previous work
  - Project structure documented: main app.py, tools/ for backend modules, templates/ for Jinja2, static/ for assets
  - Key security decorators: @require_login, @require_superadmin, @require_page_enabled("page-name")
  - Database operations centralized in tools/db_jobs.py
  - pyproject.toml references README.md for project description
---

## 2026-01-27 19:30 CST - US-004
- What was implemented:
  - Created src/ directory as main package with __init__.py
  - Created src/blueprints/ directory with 10 subdirectories: auth/, admin/, wlc/, solarwinds/, config/, bulk_ssh/, certs/, jobs/, kb/, api/
  - Each blueprint directory contains __init__.py for Python package recognition
  - Created src/core/ directory for shared utilities (db, security, helpers) with __init__.py
  - Created src/models/ directory for database models with __init__.py
- Files changed:
  - src/__init__.py (new)
  - src/blueprints/__init__.py (new)
  - src/blueprints/{auth,admin,wlc,solarwinds,config,bulk_ssh,certs,jobs,kb,api}/__init__.py (10 files, new)
  - src/core/__init__.py (new)
  - src/models/__init__.py (new)
- **Learnings for future iterations:**
  - New blueprint structure: src/blueprints/{domain}/ contains routes.py and templates/ subdirectory
  - Shared utilities will go in src/core/ (database.py, security.py, helpers.py)
  - Database models will go in src/models/ (one file per domain)
  - All __init__.py files are currently empty - they will be populated as blueprints are implemented
---

## 2026-01-27 20:15 CST - US-005
- What was implemented:
  - Created src/config.py with configuration classes (Config, DevelopmentConfig, ProductionConfig, TestingConfig)
  - Created src/app.py with create_app(config_name) factory function
  - Created wsgi.py as production entry point that imports and calls create_app("production")
  - Factory function validates SECRET_KEY is required in production mode
  - Health check endpoint at /health in the factory function
  - Error handlers for 404 and 500 registered in factory
- Files changed:
  - src/config.py (new)
  - src/app.py (new)
  - wsgi.py (new)
- **Learnings for future iterations:**
  - Config classes use class attributes with type hints for Flask configuration
  - Production requires FLASK_SECRET_KEY env var - raises RuntimeError if missing
  - get_config(config_name) helper function to retrieve config class by name
  - Factory pattern stubs for _init_extensions() and _register_blueprints() ready for future stories
  - Template/static folders configured relative to src/app.py: "../templates", "../static"
  - wsgi.py exports both `application` and `app` for compatibility with different WSGI servers
---

## 2026-01-27 19:04 CST - US-006
- What was implemented:
  - Created src/core/database.py with database connection management utilities
  - Created src/core/security.py with authentication, encryption, and access control decorators
  - Created src/core/helpers.py with common utility functions (page settings, timezone, formatting)
  - Updated src/core/__init__.py to export all utilities for easy importing
  - All modules use relative imports within the package
- Files changed:
  - src/core/database.py (new)
  - src/core/security.py (new)
  - src/core/helpers.py (new)
  - src/core/__init__.py (modified)
- **Learnings for future iterations:**
  - Import core utilities via: `from src.core import get_connection, require_login, is_page_enabled`
  - database.py: DB_PATH, get_connection(), get_db_lock(), execute_with_lock(), fetch_one(), fetch_all()
  - security.py: encrypt/decrypt_password(), require_login/superadmin/kb_create/page_enabled decorators
  - helpers.py: is_page_enabled(), get_app_timezone(), now_iso(), format_datetime()
  - Encryption key loaded from NOC_ENCRYPTION_KEY env var or .encryption_key file
  - Thread-safe database operations via _DB_LOCK context manager
---

## 2026-01-27 20:30 CST - US-007
- What was implemented:
  - Created src/blueprints/auth/routes.py with /login, /logout, /profile routes
  - Created src/blueprints/auth/templates/auth/ directory structure
  - Copied login.html to src/blueprints/auth/templates/auth/login.html
  - Copied profile.html to src/blueprints/auth/templates/auth/profile.html
  - Updated src/blueprints/auth/__init__.py to export auth_bp
  - Registered auth blueprint in src/app.py _register_blueprints()
  - Updated src/core/security.py decorators to use "auth.login" for redirects
- Files changed:
  - src/blueprints/auth/routes.py (new)
  - src/blueprints/auth/templates/auth/login.html (new)
  - src/blueprints/auth/templates/auth/profile.html (new)
  - src/blueprints/auth/__init__.py (modified)
  - src/app.py (modified)
  - src/core/security.py (modified)
- **Learnings for future iterations:**
  - Blueprint templates must be nested: templates/{blueprint_name}/ for proper Jinja2 namespacing
  - Templates use `render_template("auth/login.html")` - the blueprint prefix is required
  - url_for() in security decorators must use blueprint prefix: "auth.login" not "login"
  - Blueprint routes: use `url_prefix=""` for root-level routes or a prefix like `/auth`
  - login.html is standalone (no base.html), profile.html extends base.html
---

## 2026-01-27 21:00 CST - US-008
- What was implemented:
  - Created src/blueprints/admin/routes.py with routes: /admin/users, /admin/settings, /admin/page-settings
  - Created src/blueprints/admin/templates/admin/ directory structure
  - Copied admin_users.html to src/blueprints/admin/templates/admin/admin_users.html
  - Copied admin_settings.html to src/blueprints/admin/templates/admin/admin_settings.html
  - Copied admin_page_settings.html to src/blueprints/admin/templates/admin/admin_page_settings.html
  - Updated src/blueprints/admin/__init__.py to export admin_bp
  - Registered admin blueprint in src/app.py _register_blueprints()
  - Added save_app_settings() function to src/core/helpers.py (was missing)
  - Updated src/core/__init__.py to export save_app_settings
- Files changed:
  - src/blueprints/admin/routes.py (new)
  - src/blueprints/admin/templates/admin/admin_users.html (new)
  - src/blueprints/admin/templates/admin/admin_settings.html (new)
  - src/blueprints/admin/templates/admin/admin_page_settings.html (new)
  - src/blueprints/admin/__init__.py (modified)
  - src/app.py (modified)
  - src/core/helpers.py (modified)
  - src/core/__init__.py (modified)
- **Learnings for future iterations:**
  - Admin blueprint uses url_prefix="/admin" so routes are /admin/users not /users
  - Templates need url_for() calls updated from "admin_users" to "admin.admin_users"
  - get_page_settings() in original app.py maps to get_all_page_settings() in src/core/helpers.py
  - save_app_settings() was missing from helpers.py - needed to add it
  - Admin routes use @require_superadmin decorator from src.core.security
---

## 2026-01-27 21:20 CST - US-009
- What was implemented:
  - Created src/blueprints/wlc/routes.py with routes: /tools/wlc, /tools/wlc/dashboard, /tools/wlc/ap-inventory, /tools/wlc/ap-inventory/export, /tools/wlc/summer-guest, /tools/wlc-rf, /tools/wlc-rf-troubleshoot, /tools/wlc-clients-troubleshoot
  - Created src/blueprints/wlc/templates/wlc/ directory structure
  - Copied templates: wlc_dashboard.html, ap_inventory.html, wlc_summer_guest.html, wlc_rf.html, wlc_tools.html, wlc_rf_troubleshoot.html, wlc_clients_troubleshoot.html to src/blueprints/wlc/templates/wlc/
  - Updated src/blueprints/wlc/__init__.py to export wlc_bp
  - Registered wlc blueprint in src/app.py _register_blueprints()
- Files changed:
  - src/blueprints/wlc/routes.py (new)
  - src/blueprints/wlc/templates/wlc/wlc_dashboard.html (new)
  - src/blueprints/wlc/templates/wlc/ap_inventory.html (new)
  - src/blueprints/wlc/templates/wlc/wlc_summer_guest.html (new)
  - src/blueprints/wlc/templates/wlc/wlc_rf.html (new)
  - src/blueprints/wlc/templates/wlc/wlc_tools.html (new)
  - src/blueprints/wlc/templates/wlc/wlc_rf_troubleshoot.html (new)
  - src/blueprints/wlc/templates/wlc/wlc_clients_troubleshoot.html (new)
  - src/blueprints/wlc/__init__.py (modified)
  - src/app.py (modified)
- **Learnings for future iterations:**
  - WLC blueprint uses url_prefix="" for root-level routes (e.g., /tools/wlc)
  - Import db_jobs functions locally within route handlers to avoid circular imports
  - Helper functions for timezone and datetime formatting can be defined within the route handler
  - Templates use `render_template("wlc/wlc_dashboard.html")` - the blueprint prefix is required
  - The WLC module has many more routes in app.py (inventory/run, RF run, jobs, settings) - only extracted the core view routes per PRD
---

## 2026-01-27 21:45 CST - US-010
- What was implemented:
  - Created src/blueprints/solarwinds/routes.py with routes: /tools/solarwinds/nodes, /tools/solarwinds/inventory, /tools/solarwinds/inventory/export, /tools/solarwinds/inventory/export-summary, /api/solarwinds/nodes, /tools/solarwinds/nodes/settings
  - Created src/blueprints/solarwinds/templates/solarwinds/ directory structure
  - Copied and updated templates: solarwinds_nodes.html, solarwinds_inventory.html, solarwinds_nodes_settings.html
  - Updated url_for() calls in templates to use blueprint prefix (solarwinds.route_name)
  - Updated src/blueprints/solarwinds/__init__.py to export solarwinds_bp
  - Registered solarwinds blueprint in src/app.py _register_blueprints()
  - Included helper functions: _match_version_pattern(), _apply_inventory_filters(), _get_solar_settings(), _set_solar_settings(), _run_solarwinds_poll()
- Files changed:
  - src/blueprints/solarwinds/routes.py (new)
  - src/blueprints/solarwinds/templates/solarwinds/solarwinds_nodes.html (new)
  - src/blueprints/solarwinds/templates/solarwinds/solarwinds_inventory.html (new)
  - src/blueprints/solarwinds/templates/solarwinds/solarwinds_nodes_settings.html (new)
  - src/blueprints/solarwinds/__init__.py (modified)
  - src/app.py (modified)
- **Learnings for future iterations:**
  - SolarWinds blueprint uses url_prefix="" for root-level routes (e.g., /tools/solarwinds/nodes)
  - The solarwinds routes include both view routes AND export routes for CSV downloads
  - Settings route includes _run_solarwinds_poll() helper which calls tools.solarwinds.fetch_nodes
  - Templates reference external routes like 'changes_list' which remain in app.py
  - Use _apply_inventory_filters() helper to avoid duplicating filter logic across routes
---

## 2026-01-27 22:10 CST - US-011
- What was implemented:
  - Created src/blueprints/config/routes.py with routes: /tools/phrase-search, /search, /download-csv, /tools/global-config, /global/search, /global/download-csv, /global/actions/*, /changes, /changes/<id>, /changes/<id>/start, /changes/<id>/rollback, /actions/*
  - Created src/blueprints/config/templates/config/ directory structure
  - Copied and updated phrase_search.html, global_config.html, changes.html to src/blueprints/config/templates/config/
  - Updated url_for() calls in templates to use blueprint prefix (config.route_name, solarwinds.solarwinds_nodes)
  - Updated src/blueprints/config/__init__.py to export config_bp
  - Registered config blueprint in src/app.py _register_blueprints()
  - Included helper functions: _solar_node_options(), _parse_hosts_field(), _format_cst(), _parse_cst_datetime(), _new_job_id(), _filter_cli_map(), _run_cli_job_sync(), _start_background_cli_job(), _get_cli_job_state(), _job_outcome(), _start_change_execution(), _start_change_rollback()
- Files changed:
  - src/blueprints/config/routes.py (new)
  - src/blueprints/config/templates/config/phrase_search.html (new)
  - src/blueprints/config/templates/config/global_config.html (new)
  - src/blueprints/config/templates/config/changes.html (new)
  - src/blueprints/config/__init__.py (modified)
  - src/app.py (modified)
- **Learnings for future iterations:**
  - Config blueprint uses url_prefix="" for root-level routes (e.g., /tools/phrase-search, /changes)
  - Many helper functions were duplicated from app.py to keep the blueprint self-contained
  - Templates that render shared results (results.html, action_preview.html, action_result.html, change_detail.html, global_config_results.html, action_preview_global.html) remain in root templates/ folder and are used by multiple blueprints
  - The _CHANGE_WAKE threading.Event is created lazily via _get_change_wake() since it can't be shared between modules
  - Cross-blueprint references: phrase_search and global_config templates reference solarwinds.solarwinds_nodes for the "Sync from Nodes" link
  - Action routes (/actions/*, /global/actions/*) handle both synchronous and background job execution
---

## 2026-01-27 22:45 CST - US-012
- What was implemented:
  - Created src/blueprints/bulk_ssh/routes.py with routes: /tools/bulk-ssh, /tools/bulk-ssh/execute, /tools/bulk-ssh/results/<job_id>, /tools/bulk-ssh/jobs, /tools/bulk-ssh/templates, /tools/bulk-ssh/templates/create, /tools/bulk-ssh/templates/<id>/update, /tools/bulk-ssh/templates/<id>/delete, /tools/bulk-ssh/templates/seed-defaults, /tools/bulk-ssh/schedules, /tools/bulk-ssh/schedules/create, /tools/bulk-ssh/schedules/<id>/toggle, /tools/bulk-ssh/schedules/<id>/delete, /api/bulk-ssh/status/<job_id>, /api/bulk-ssh/export/<job_id>, /api/bulk-ssh/templates, /api/bulk-ssh/templates/<id>
  - Created src/blueprints/bulk_ssh/templates/bulk_ssh/ directory structure
  - Copied and updated templates: bulk_ssh.html, bulk_ssh_templates.html, bulk_ssh_schedules.html, bulk_ssh_results.html, bulk_ssh_jobs.html
  - Updated url_for() calls in all templates to use blueprint prefix (bulk_ssh.route_name)
  - Updated src/blueprints/bulk_ssh/__init__.py to export bulk_ssh_bp
  - Registered bulk_ssh blueprint in src/app.py _register_blueprints()
- Files changed:
  - src/blueprints/bulk_ssh/routes.py (new)
  - src/blueprints/bulk_ssh/templates/bulk_ssh/bulk_ssh.html (new)
  - src/blueprints/bulk_ssh/templates/bulk_ssh/bulk_ssh_templates.html (new)
  - src/blueprints/bulk_ssh/templates/bulk_ssh/bulk_ssh_schedules.html (new)
  - src/blueprints/bulk_ssh/templates/bulk_ssh/bulk_ssh_results.html (new)
  - src/blueprints/bulk_ssh/templates/bulk_ssh/bulk_ssh_jobs.html (new)
  - src/blueprints/bulk_ssh/__init__.py (modified)
  - src/app.py (modified)
- **Learnings for future iterations:**
  - Bulk SSH blueprint uses url_prefix="" for root-level routes (e.g., /tools/bulk-ssh)
  - Routes include both view routes AND API routes for status polling and CSV export
  - Template create/update/delete routes are POST-only for CRUD operations
  - Schedule routes handle different schedule types (once, daily, weekly) with timezone-aware datetime calculations
  - The execute route spawns a background thread using threading.Thread(target=run_job, daemon=True)
  - Templates redirect to job_progress_page (in root app.py) for unified job progress tracking
  - CST timezone handling uses zoneinfo.ZoneInfo with pytz fallback for Python 3.8 compatibility
---

## 2026-01-27 23:15 CST - US-013
- What was implemented:
  - Created src/blueprints/certs/routes.py with routes: /certs, /certs/export, /certs/upload, /certs/<id>/edit, /certs/<id>/delete, /certs/<id>/view, /certs/chain, /certs/converter, /ise-nodes, /ise-nodes/add, /ise-nodes/<id>/edit, /ise-nodes/<id>/delete, /ise-nodes/<id>/toggle, /ise-nodes/<id>/sync, /ise-nodes/sync-all, /ise-nodes/settings, /ise-nodes/<id>/fetch-version, /ise-nodes/fetch-all-versions
  - Created src/blueprints/certs/templates/certs/ directory structure
  - Copied and updated templates: cert_tracker.html, cert_view.html, cert_upload.html, cert_edit.html, cert_chain.html, cert_converter.html, ise_nodes.html, ise_node_edit.html
  - Updated url_for() calls in all templates to use blueprint prefix (certs.route_name)
  - Updated src/blueprints/certs/__init__.py to export certs_bp
  - Registered certs blueprint in src/app.py _register_blueprints()
- Files changed:
  - src/blueprints/certs/routes.py (new)
  - src/blueprints/certs/templates/certs/cert_tracker.html (new)
  - src/blueprints/certs/templates/certs/cert_view.html (new)
  - src/blueprints/certs/templates/certs/cert_upload.html (new)
  - src/blueprints/certs/templates/certs/cert_edit.html (new)
  - src/blueprints/certs/templates/certs/cert_chain.html (new)
  - src/blueprints/certs/templates/certs/cert_converter.html (new)
  - src/blueprints/certs/templates/certs/ise_nodes.html (new)
  - src/blueprints/certs/templates/certs/ise_node_edit.html (new)
  - src/blueprints/certs/__init__.py (modified)
  - src/app.py (modified)
- **Learnings for future iterations:**
  - Certs blueprint uses url_prefix="" for root-level routes (e.g., /certs, /ise-nodes)
  - Certificate routes include filtering, sorting, and CSV export functionality
  - ISE node management includes CRUD operations, certificate syncing, and version fetching
  - The cert_converter route uses tools/cert_converter module for PFX/PEM/DER conversions
  - Decorator nesting pattern: define inner function decorated with @require_login/@require_page_enabled and call it
  - _get_cst_tz() helper returns timezone object with zoneinfo/pytz fallback
---

## 2026-01-27 23:45 CST - US-014
- What was implemented:
  - Created src/blueprints/jobs/routes.py with routes: /jobs, /jobs/<job_id>, /api/jobs, /api/jobs/<job_id>/cancel, /jobs/<job_id>/progress, /api/jobs/<job_id>/progress
  - Created src/blueprints/jobs/templates/jobs/ directory structure
  - Created templates: jobs_center.html, job_detail.html, job_progress.html with blueprint-aware url_for() calls
  - Updated url_for() calls in all templates to use blueprint prefix (jobs.route_name)
  - Updated src/blueprints/jobs/__init__.py to export jobs_bp
  - Registered jobs blueprint in src/app.py _register_blueprints()
- Files changed:
  - src/blueprints/jobs/routes.py (new)
  - src/blueprints/jobs/templates/jobs/jobs_center.html (new)
  - src/blueprints/jobs/templates/jobs/job_detail.html (new)
  - src/blueprints/jobs/templates/jobs/job_progress.html (new)
  - src/blueprints/jobs/__init__.py (modified)
  - src/app.py (modified)
- **Learnings for future iterations:**
  - Jobs blueprint uses url_prefix="" for root-level routes (e.g., /jobs, /api/jobs)
  - Jobs center aggregates both generic jobs (from jobs table) and bulk SSH jobs (from bulk_ssh_jobs table)
  - _format_cst() helper uses get_app_timezone_info() from src.core.helpers for timezone-aware formatting
  - The job_progress page polls /api/jobs/<job_id>/progress every 800ms for live updates
  - Templates use safe DOM methods (textContent, createElement) instead of innerHTML where possible for XSS prevention
  - Job progress API supports both generic jobs and bulk SSH jobs with different data structures
---

## 2026-01-27 - US-015
- What was implemented:
  - Created src/blueprints/kb/routes.py with routes: /knowledge-base, /knowledge-base/create, /knowledge-base/<int:article_id>, /knowledge-base/<int:article_id>/edit, /knowledge-base/<int:article_id>/delete
  - Created src/blueprints/kb/templates/kb/ directory structure
  - Created templates: knowledge_base.html (list view), knowledge_base_article.html (detail view), knowledge_base_form.html (create/edit form)
  - Updated url_for() calls in all templates to use blueprint prefix (kb.route_name)
  - Updated src/blueprints/kb/__init__.py to export kb_bp
  - Registered kb blueprint in src/app.py _register_blueprints()
  - Included helper functions: _get_kb_articles_for_user(), _get_kb_article(), _create_kb_article(), _update_kb_article(), _delete_kb_article(), _get_kb_subjects(), _can_user_create_kb()
- Files changed:
  - src/blueprints/kb/routes.py (new)
  - src/blueprints/kb/templates/kb/knowledge_base.html (new)
  - src/blueprints/kb/templates/kb/knowledge_base_article.html (new)
  - src/blueprints/kb/templates/kb/knowledge_base_form.html (new)
  - src/blueprints/kb/__init__.py (modified)
  - src/app.py (modified)
- **Learnings for future iterations:**
  - KB blueprint uses url_prefix="" for root-level routes (e.g., /knowledge-base)
  - KB helper functions already exist in src/core/security.py: get_kb_access_level(), can_view_kb_article(), log_audit()
  - require_kb_create decorator from src.core is used for article creation/editing permissions
  - knowledge_base_form.html uses JavaScript for subject autocomplete/suggestions
  - Templates use visibility-badge classes with FSR/NOC/Admin visibility levels for access control display
  - Article listing supports filtering by subject and searching by title/content
---

## 2026-01-27 - US-016
- What was implemented:
  - Moved base.html to src/templates/base.html
  - Moved static/ directory contents to src/static/
  - Updated Flask app config in src/app.py to use "templates" and "static" folders (relative to src/)
  - Updated url_for() calls in base.html to use blueprint prefixes for all extracted routes
- Files changed:
  - src/templates/base.html (new - copied from templates/base.html with updated url_for calls)
  - src/static/host_selector.js (new - copied from static/)
  - src/app.py (modified - updated template_folder and static_folder paths)
- **Learnings for future iterations:**
  - Template folder paths are relative to the app.py location: use "templates" not "../templates" when templates are in src/templates/
  - Blueprint url_for format: "blueprint_name.function_name" (e.g., "auth.login", "wlc.wlc_dashboard")
  - Routes still in old app.py (not yet in blueprints): index, audit_logs, device_inventory, customer_dashboard, topology_tool
  - The wlc_inventory route was renamed to wlc.wlc_ap_inventory in the WLC blueprint
  - request.endpoint checks in templates also need blueprint prefix (e.g., 'wlc.wlc_dashboard' not 'wlc_dashboard')
---

## 2026-01-27 - US-017
- What was implemented:
  - Added Flask-SQLAlchemy>=3.1.1 and psycopg2-binary>=2.9.9 to requirements/base.txt
  - Created src/models/user.py with User and Session models
  - Created src/models/settings.py with AppSettings and PageSettings models
  - Updated src/models/__init__.py to create db instance and export all models
  - User model includes: username (indexed), password_hash, role, created_at, last_login, kb_access_level, can_create_kb
  - Session model includes: user_id (FK), session_token (indexed), ip_address, user_agent, created_at, expires_at
  - AppSettings model uses singleton pattern (id=1 constraint) with timezone setting
  - PageSettings model includes: page_key (PK), page_name, enabled, category (indexed)
- Files changed:
  - requirements/base.txt (modified)
  - src/models/__init__.py (modified)
  - src/models/user.py (new)
  - src/models/settings.py (new)
- **Learnings for future iterations:**
  - SQLAlchemy models go in src/models/ with one file per domain
  - Import db from src.models (e.g., `from src.models import db, User`)
  - Use `from . import db` within model files to get shared db instance
  - Singleton pattern: use db.CheckConstraint("id = 1") in __table_args__
  - Forward references in relationships: use string like "KBArticle" for models not yet defined
  - User model has helper methods: set_password(), check_password(), is_superadmin property
  - PageSettings has class methods: is_page_enabled(), get_all_pages(), set_page_enabled()
---

## 2026-01-27 - US-018
- What was implemented:
  - Created src/models/job.py with Job and JobEvent models
  - Created src/models/audit.py with AuditLog model
  - Updated src/models/__init__.py to export new models (Job, JobEvent, AuditLog)
  - Job model includes: job_id (PK), created, tool (indexed), params_json, done, cancelled
  - JobEvent model includes: id (PK), job_id (FK indexed), ts (indexed), type (indexed), payload_json
  - AuditLog model includes: id (PK), user_id (FK indexed), username (indexed), action, resource, ip_address, timestamp (indexed), details
  - Foreign key relationships defined correctly with cascade delete behaviors
- Files changed:
  - src/models/job.py (new)
  - src/models/audit.py (new)
  - src/models/__init__.py (modified)
- **Learnings for future iterations:**
  - Job model has helper methods: is_complete property, mark_done(), mark_cancelled(), add_event()
  - AuditLog model has class method: log() for creating audit entries with all fields
  - JobEvent types are: created, sample, error, done, cancelled, note
  - Use ondelete="CASCADE" for FK to cascade deletes, ondelete="SET NULL" for audit logs to preserve history
  - Job.events relationship uses order_by="JobEvent.ts" for chronological ordering
---

## 2026-01-27 - US-019
- What was implemented:
  - Created src/models/wlc.py with WLC-related models:
    - WLCDashboardSettings: singleton settings for WLC dashboard polling config
    - WLCSample: dashboard polling sample data
    - WLCSummerSettings: settings for summer guest SSID monitoring
    - WLCSummerSample: sample data for summer guest SSID status
    - APInventory: access point inventory tracking across WLCs
    - APInventorySettings: singleton settings for AP inventory cleanup
  - Created src/models/solarwinds.py with SolarWinds integration models:
    - SolarWindsSettings: singleton settings for SolarWinds API connection
    - SolarWindsNode: network device inventory from SolarWinds
  - Updated src/models/__init__.py to export all new models
  - All models include proper indexes matching SQLite schema
- Files changed:
  - src/models/wlc.py (new)
  - src/models/solarwinds.py (new)
  - src/models/__init__.py (modified)
- **Learnings for future iterations:**
  - WLC models include additional tables not in PRD: WLCSummerSettings, WLCSummerSample, APInventorySettings
  - Singleton pattern: use db.CheckConstraint("id = 1") in __table_args__
  - SolarWindsNode includes hardware_version column for CVE analysis
  - APInventory uses composite unique constraint on (ap_mac, wlc_host)
  - Settings models have get_settings() class method for getting/creating singleton instance
  - Use UniqueConstraint in __table_args__ for multi-column unique constraints
---

## 2026-01-27 - US-020
- What was implemented:
  - Created src/models/bulk_ssh.py with Bulk SSH models:
    - BulkSSHJob: Tracks bulk SSH command execution with progress counters
    - BulkSSHResult: Stores individual device results with output/status
    - BulkSSHTemplate: Reusable command templates with category and variables
    - BulkSSHSchedule: Scheduled bulk SSH jobs with next_run/last_run tracking
  - Created src/models/config.py with configuration management models:
    - ChangeWindow: Configuration change window scheduling and execution tracking
    - ChangeEvent: Event logging during change window execution
  - Updated src/models/__init__.py to export all new models
  - All models include proper indexes matching the SQLite schema in db_jobs.py
- Files changed:
  - src/models/bulk_ssh.py (new)
  - src/models/config.py (new)
  - src/models/__init__.py (modified)
- **Learnings for future iterations:**
  - BulkSSHJob includes progress_percent property for calculating completion percentage
  - BulkSSHSchedule.fetch_due_schedules() class method for finding schedules ready to run
  - ChangeWindow has status lifecycle methods: start(), complete(), fail(), rollback(), cancel()
  - ChangeWindow.add_event() helper for adding associated ChangeEvent records
  - Use ondelete="CASCADE" on ForeignKey for automatic cleanup of related records
  - Status enums documented in comments: e.g., "scheduled|running|completed|failed|rolled_back|cancelled"
---

## 2026-01-27 - US-021
- What was implemented:
  - Created src/models/cert.py with certificate and ISE node models:
    - Certificate: Tracks SSL/TLS certificates with expiry, CN, serial, source info
    - ISENode: Manages Cisco ISE nodes for certificate syncing with credentials
    - CertSyncSettings: Singleton settings for auto-sync configuration
  - Created src/models/kb.py with KBArticle model:
    - KBArticle: Knowledge base articles with visibility levels (FSR/NOC/Admin)
    - Includes author relationship to User model
    - Search and filtering class methods
  - Updated src/models/__init__.py to export all new models
  - All models include proper indexes matching the SQLite schema
- Files changed:
  - src/models/cert.py (new)
  - src/models/kb.py (new)
  - src/models/__init__.py (modified)
- **Learnings for future iterations:**
  - Certificate model has is_expired property and days_until_expiry helper
  - ISENode uses Integer for enabled (1/0) instead of Boolean for SQLite compatibility
  - CertSyncSettings follows singleton pattern with CheckConstraint("id = 1")
  - KBArticle.get_visible_to_user() filters by visibility level hierarchy
  - KBArticle uses back_populates="kb_articles" relationship with User model
  - Use db.or_() for combining filter conditions in SQLAlchemy queries
---

## 2026-01-27 - US-022
- What was implemented:
  - Added Flask-Migrate>=4.0.5 to requirements/base.txt
  - Created migrations/ directory with Alembic configuration:
    - migrations/alembic.ini: Alembic configuration file
    - migrations/env.py: Flask-Migrate environment configuration
    - migrations/script.py.mako: Template for generating migrations
    - migrations/README: Documentation for migration usage
  - Created migrations/versions/001_initial_schema.py with all models:
    - users, sessions tables for authentication
    - app_settings, page_settings tables for configuration
    - jobs, job_events tables for job tracking
    - audit_log table for audit trail
    - wlc_dashboard_settings, wlc_dashboard_samples, wlc_summer_settings, wlc_summer_samples, ap_inventory, ap_inventory_settings tables for WLC
    - solarwinds_settings, solarwinds_nodes tables for SolarWinds integration
    - bulk_ssh_jobs, bulk_ssh_results, bulk_ssh_templates, bulk_ssh_schedules tables for bulk SSH
    - change_windows, change_events tables for config management
    - certificates, ise_nodes, cert_sync_settings tables for certificate tracking
    - kb_articles table for knowledge base
  - Updated src/app.py to initialize Flask-SQLAlchemy (db) and Flask-Migrate (migrate) extensions
  - Created scripts/init_db.py for first-time database setup with:
    - Database migration execution
    - Seed data for page settings and app settings
    - Reset functionality for development
- Files changed:
  - requirements/base.txt (modified)
  - src/app.py (modified)
  - migrations/alembic.ini (new)
  - migrations/env.py (new)
  - migrations/script.py.mako (new)
  - migrations/README (new)
  - migrations/versions/001_initial_schema.py (new)
  - scripts/init_db.py (new)
- **Learnings for future iterations:**
  - Flask-Migrate CLI commands: `flask db migrate -m "desc"`, `flask db upgrade`, `flask db downgrade`
  - migrations/env.py handles Flask-SQLAlchemy>=3 compatibility automatically
  - Initial migration uses op.create_table() with sa.Column() definitions
  - Singleton tables use CheckConstraint("id = 1", name="singleton_tablename")
  - scripts/init_db.py can be run with `python scripts/init_db.py` or `python scripts/init_db.py --reset`
  - db.init_app(app) and migrate.init_app(app, db) are called in _init_extensions()
---

## 2026-01-27 - US-023
- What was implemented:
  - Created src/blueprints/setup/ directory with __init__.py and routes.py
  - Created setup wizard template at src/blueprints/setup/templates/setup/setup_wizard.html
  - Setup wizard route /setup collects admin username and password
  - is_first_run() function checks for empty users table in database
  - Password validation requires minimum 12 characters
  - Created admin user with superadmin role, Admin kb_access_level, can_create_kb=True
  - After successful setup, redirects to auth.login with flash message
  - Setup route returns 404 if users already exist in database
  - Added before_request middleware in _register_request_handlers() to redirect to /setup on first run
  - Middleware excludes /setup, /health, and /static/* paths from redirect
  - Registered setup blueprint in app factory _register_blueprints()
- Files changed:
  - src/blueprints/setup/__init__.py (new)
  - src/blueprints/setup/routes.py (new)
  - src/blueprints/setup/templates/setup/setup_wizard.html (new)
  - src/app.py (modified - added setup_bp import, registration, and _register_request_handlers)
- **Learnings for future iterations:**
  - First-run detection: check User.query.count() == 0 with exception handling
  - before_request middleware checks request.endpoint for route exclusions
  - Setup blueprint uses same visual style as login.html (standalone page, not base.html)
  - Password strength indicator uses CSS classes: weak (red), medium (yellow), strong (green)
  - Admin user created with set_password() method from User model
  - Middleware returns None to continue request processing, redirect() to intercept
---
