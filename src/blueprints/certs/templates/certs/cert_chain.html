{% extends "base.html" %}
{% block title %}Certificate Chain{% endblock %}
{% block head_extra %}
<style>
  .chain-container{
    position:relative;
  }
  .chain-line{
    position:absolute;
    left:24px;
    top:60px;
    bottom:60px;
    width:2px;
    background:linear-gradient(to bottom, var(--accent), var(--accent-2));
  }
  .cert-chain-card{
    background: color-mix(in oklab, var(--card) 96%, transparent);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
    margin-bottom:16px;
    margin-left:48px;
    position:relative;
  }
  .cert-chain-card::before{
    content:'';
    position:absolute;
    left:-26px;
    top:50%;
    width:24px;
    height:2px;
    background:var(--border);
  }
  .chain-node{
    position:absolute;
    left:12px;
    width:24px;
    height:24px;
    border-radius:50%;
    background:var(--card);
    border:3px solid var(--accent);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:11px;
    font-weight:700;
    color:var(--accent);
  }
  .chain-node.root{
    border-color:var(--success);
    color:var(--success);
  }
  .chain-node.leaf{
    border-color:var(--info);
    color:var(--info);
  }

  .cert-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    margin-bottom:16px;
    flex-wrap:wrap;
    gap:12px;
  }
  .cert-title h3{margin:0 0 4px; font-size:16px;}
  .cert-title .type-badge{
    display:inline-block;
    padding:2px 8px;
    border-radius:4px;
    font-size:11px;
    font-weight:600;
    text-transform:uppercase;
  }
  .type-badge.root{background:rgba(34,197,94,0.15); color:var(--success);}
  .type-badge.intermediate{background:rgba(59,130,246,0.15); color:var(--info);}
  .type-badge.leaf{background:rgba(168,85,247,0.15); color:#a855f7;}

  .cert-status{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 12px;
    border-radius:6px;
    font-size:13px;
    font-weight:600;
  }
  .cert-status.exp-expired{background:rgba(239,68,68,0.15); color:var(--error);}
  .cert-status.exp-critical{background:rgba(239,68,68,0.1); color:var(--error);}
  .cert-status.exp-warning{background:rgba(245,158,11,0.1); color:var(--warning);}
  .cert-status.exp-caution{background:rgba(234,179,8,0.08); color:#ca8a04;}
  .cert-status.exp-ok{background:rgba(34,197,94,0.1); color:var(--success);}
  .cert-status.exp-unknown{background:rgba(148,163,184,0.1); color:var(--muted);}

  .detail-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
    gap:12px;
  }
  .detail-item{font-size:13px;}
  .detail-label{color:var(--muted); margin-bottom:2px;}
  .detail-value{font-weight:500; word-break:break-all;}

  .san-list{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:12px;
  }
  .san-tag{
    display:inline-block;
    padding:3px 8px;
    background:color-mix(in oklab, var(--accent) 10%, transparent);
    border:1px solid color-mix(in oklab, var(--accent) 30%, transparent);
    color:var(--text);
    border-radius:4px;
    font-size:12px;
    font-family:monospace;
  }

  .serial-number{
    font-family:monospace;
    font-size:11px;
    background:var(--bg);
    padding:6px 10px;
    border-radius:4px;
    word-break:break-all;
    margin-top:12px;
  }

  .toggle-details{
    margin-top:12px;
    font-size:13px;
    color:var(--accent);
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:4px;
  }
  .toggle-details:hover{text-decoration:underline;}
  .extra-details{display:none; margin-top:16px; padding-top:16px; border-top:1px solid var(--border);}
  .extra-details.show{display:block;}
</style>
{% endblock %}
{% block content %}
<div style="max-width:900px; margin:0 auto;">
  <div style="margin-bottom:24px;">
    <a href="{{ url_for('certs.cert_tracker') }}" class="muted" style="text-decoration:none;">&larr; Back to Certificate Tracker</a>
  </div>

  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; flex-wrap:wrap; gap:12px;">
    <div>
      <h2 style="margin:0;">Certificate Chain</h2>
      <p class="muted" style="margin:4px 0 0;">{{ filename }} - {{ chain|length }} certificate(s) in chain</p>
    </div>
    <a href="{{ url_for('certs.cert_tracker') }}" class="btn">Upload Another</a>
  </div>

  <div class="chain-container">
    {% if chain|length > 1 %}
    <div class="chain-line"></div>
    {% endif %}

    {% for cert in chain %}
    <div style="position:relative; margin-bottom:16px;">
      <div class="chain-node {% if cert.is_root %}root{% elif loop.first %}leaf{% endif %}">
        {{ loop.index }}
      </div>
      <div class="cert-chain-card">
        <div class="cert-header">
          <div class="cert-title">
            <h3>{{ cert.cn or cert.subject_cn or 'Unknown' }}</h3>
            <span class="type-badge {% if cert.is_root %}root{% elif loop.first %}leaf{% else %}intermediate{% endif %}">
              {% if cert.is_root %}Root CA{% elif loop.first %}Leaf{% else %}Intermediate{% endif %}
            </span>
          </div>
          <div class="cert-status {{ cert.expiry_class }}">
            {% if cert.days_left is not none %}
              {% if cert.days_left < 0 %}
                Expired
              {% elif cert.days_left == 0 %}
                Expires Today
              {% else %}
                {{ cert.days_left }}d left
              {% endif %}
            {% else %}
              Unknown
            {% endif %}
          </div>
        </div>

        <div class="detail-grid">
          <div class="detail-item">
            <div class="detail-label">Subject</div>
            <div class="detail-value">{{ cert.subject_cn or 'Unknown' }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Issuer</div>
            <div class="detail-value">{{ cert.issuer_cn or 'Unknown' }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Valid From</div>
            <div class="detail-value">{{ cert.not_before or 'Unknown' }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Expires</div>
            <div class="detail-value">{{ cert.expires_formatted or cert.not_after or 'Unknown' }}</div>
          </div>
          {% if cert.key_size %}
          <div class="detail-item">
            <div class="detail-label">Key Size</div>
            <div class="detail-value">{{ cert.key_size }}</div>
          </div>
          {% endif %}
          {% if cert.signature_algo %}
          <div class="detail-item">
            <div class="detail-label">Signature</div>
            <div class="detail-value">{{ cert.signature_algo }}</div>
          </div>
          {% endif %}
        </div>

        {% if cert.sans %}
        <div style="margin-top:12px;">
          <div class="detail-label">Subject Alternative Names ({{ cert.sans|length }})</div>
          <div class="san-list">
            {% for san in cert.sans[:10] %}
            <span class="san-tag">{{ san }}</span>
            {% endfor %}
            {% if cert.sans|length > 10 %}
            <span class="san-tag">+{{ cert.sans|length - 10 }} more</span>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <span class="toggle-details" onclick="toggleDetails(this)">
          <span class="arrow">&#9654;</span> Show more details
        </span>

        <div class="extra-details">
          {% if cert.subject_dn %}
          <div class="detail-item" style="margin-bottom:12px;">
            <div class="detail-label">Full Subject DN</div>
            <div class="detail-value" style="font-size:12px;">{{ cert.subject_dn }}</div>
          </div>
          {% endif %}
          {% if cert.issuer_dn %}
          <div class="detail-item" style="margin-bottom:12px;">
            <div class="detail-label">Full Issuer DN</div>
            <div class="detail-value" style="font-size:12px;">{{ cert.issuer_dn }}</div>
          </div>
          {% endif %}

          {% if cert.key_usage %}
          <div class="detail-item" style="margin-bottom:12px;">
            <div class="detail-label">Key Usage</div>
            <div class="san-list">
              {% for ku in cert.key_usage %}
              <span class="san-tag">{{ ku }}</span>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if cert.ext_key_usage %}
          <div class="detail-item" style="margin-bottom:12px;">
            <div class="detail-label">Extended Key Usage</div>
            <div class="san-list">
              {% for eku in cert.ext_key_usage %}
              <span class="san-tag">{{ eku }}</span>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if cert.serial %}
          <div class="detail-item" style="margin-bottom:12px;">
            <div class="detail-label">Serial Number</div>
            <div class="serial-number">{{ cert.serial }}</div>
          </div>
          {% endif %}

          {% if cert.fingerprint_sha256 %}
          <div class="detail-item">
            <div class="detail-label">SHA-256 Fingerprint</div>
            <div class="serial-number">{{ cert.fingerprint_sha256 }}</div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
function toggleDetails(el) {
  const details = el.nextElementSibling;
  const arrow = el.querySelector('.arrow');
  details.classList.toggle('show');
  if (details.classList.contains('show')) {
    arrow.textContent = '\u25BC';
    el.childNodes[el.childNodes.length - 1].textContent = ' Hide details';
  } else {
    arrow.textContent = '\u25B6';
    el.childNodes[el.childNodes.length - 1].textContent = ' Show more details';
  }
}
</script>
{% endblock %}
