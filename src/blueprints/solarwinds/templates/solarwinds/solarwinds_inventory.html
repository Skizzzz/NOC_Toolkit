{% extends "base.html" %}
{% block title %}SolarWinds Inventory{% endblock %}
{% block head_extra %}
<style>
  .page-header{
    background: linear-gradient(135deg, rgba(255,165,0,0.1) 0%, rgba(245,4,80,0.08) 100%);
    border:1px solid var(--border);
    border-radius:12px;
    padding:24px;
    margin-bottom:24px;
  }
  .page-header h2{margin:0 0 8px 0; font-size:28px; font-family:'Instrument Sans', sans-serif;}
  .page-header p{margin:0; font-size:15px; line-height:1.5; color:var(--muted);}

  .nav-pills{
    display:flex;
    gap:8px;
    margin-bottom:24px;
  }
  .nav-pills a{
    padding:10px 18px;
    border-radius:8px;
    font-size:13px;
    font-weight:600;
    text-decoration:none;
    color:var(--text);
    background:var(--card);
    border:1px solid var(--border);
    transition: all 0.2s ease;
  }
  .nav-pills a:hover{
    border-color:var(--accent);
    background: color-mix(in oklab, var(--accent) 8%, var(--card));
  }
  .nav-pills a.active{
    background:var(--accent);
    color:#fff;
    border-color:var(--accent);
  }

  .summary-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));
    gap:20px;
    margin-bottom:24px;
  }
  .summary-card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
  }
  .summary-card h3{
    margin:0 0 16px 0;
    font-size:14px;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:0.05em;
    color:var(--muted);
    display:flex;
    align-items:center;
    gap:8px;
  }
  .summary-card h3 svg{
    width:18px;
    height:18px;
    color:var(--accent);
  }

  .bar-chart{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .bar-item{
    display:flex;
    align-items:center;
    gap:12px;
    cursor:pointer;
    padding:6px 8px;
    margin:-6px -8px;
    border-radius:6px;
    transition: background 0.15s ease;
  }
  .bar-item:hover{
    background: color-mix(in oklab, var(--accent) 8%, transparent);
  }
  .bar-label{
    flex:0 0 140px;
    font-size:12px;
    font-weight:500;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .bar-track{
    flex:1;
    height:20px;
    background: color-mix(in oklab, var(--border) 50%, transparent);
    border-radius:4px;
    overflow:hidden;
  }
  .bar-fill{
    height:100%;
    background:linear-gradient(90deg, var(--accent), var(--pink));
    border-radius:4px;
    transition: width 0.3s ease;
  }
  .bar-fill.vendor-cisco{background:linear-gradient(90deg, #049fd9, #0077b6);}
  .bar-fill.vendor-dell{background:linear-gradient(90deg, #007db8, #0056b3);}
  .bar-fill.vendor-aruba{background:linear-gradient(90deg, #ff8300, #e65100);}
  .bar-fill.vendor-juniper{background:linear-gradient(90deg, #84bd00, #558b2f);}
  .bar-fill.vendor-hp, .bar-fill.vendor-hewlett{background:linear-gradient(90deg, #0096d6, #0056b3);}
  .bar-count{
    flex:0 0 60px;
    text-align:right;
    font-size:13px;
    font-weight:700;
    font-family:'Instrument Sans', sans-serif;
    color:var(--accent);
  }

  .filter-panel{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
    margin-bottom:20px;
  }
  .filter-panel h3{
    margin:0 0 16px 0;
    font-size:14px;
    font-weight:600;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .filter-panel h3 svg{
    width:18px;
    height:18px;
    color:var(--accent);
  }
  .filter-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
    gap:16px;
    margin-bottom:16px;
  }
  .filter-field{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .filter-field label{
    font-size:11px;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:0.05em;
    color:var(--muted);
  }
  .filter-field input, .filter-field select{
    padding:10px 12px;
    border-radius:8px;
    border:1px solid var(--border);
    background:var(--bg);
    color:var(--text);
    font-size:13px;
    transition: all 0.2s ease;
  }
  .filter-field input:focus, .filter-field select:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 15%, transparent);
  }
  .filter-field select[multiple]{
    height:120px;
    padding:8px;
  }
  .filter-field select[multiple] option{
    padding:6px 10px;
    border-radius:4px;
    margin-bottom:2px;
  }
  .filter-field select[multiple] option:checked{
    background:var(--accent);
    color:#fff;
  }

  .filter-actions{
    display:flex;
    gap:12px;
    align-items:center;
    padding-top:16px;
    border-top:1px solid var(--border);
  }
  .filter-actions .btn{
    padding:10px 20px;
  }

  .stats-bar{
    display:flex;
    gap:20px;
    align-items:center;
    padding:14px 16px;
    background: color-mix(in oklab, var(--accent) 6%, var(--card));
    border:1px solid color-mix(in oklab, var(--accent) 20%, var(--border));
    border-radius:10px;
    margin-bottom:20px;
  }
  .stats-bar .stat{
    display:flex;
    align-items:center;
    gap:8px;
    font-size:13px;
  }
  .stats-bar .stat svg{
    width:16px;
    height:16px;
    color:var(--accent);
  }
  .stats-bar .stat-value{
    font-weight:700;
    color:var(--accent);
    font-family:'Instrument Sans', sans-serif;
  }

  .table-container{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    overflow:hidden;
  }
  .inv-table{
    width:100%;
    border-collapse:collapse;
  }
  .inv-table th{
    text-align:left;
    padding:14px 16px;
    background: color-mix(in oklab, var(--card) 94%, transparent);
    border-bottom:2px solid var(--border);
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:0.05em;
    color:var(--muted);
    font-weight:600;
    position:sticky;
    top:0;
    z-index:1;
  }
  .inv-table td{
    padding:14px 16px;
    border-bottom:1px solid var(--border);
    font-size:13px;
  }
  .inv-table tbody tr{
    transition: background 0.15s ease;
  }
  .inv-table tbody tr:hover{
    background: color-mix(in oklab, var(--accent) 4%, transparent);
  }
  .inv-table tbody tr:last-child td{
    border-bottom:none;
  }

  .vendor-badge{
    display:inline-block;
    padding:4px 10px;
    border-radius:999px;
    font-size:10px;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:0.03em;
  }
  .vendor-badge.cisco{background:rgba(4,159,217,0.15); color:#049fd9;}
  .vendor-badge.aruba{background:rgba(255,131,0,0.15); color:#ff8300;}
  .vendor-badge.dell{background:rgba(0,125,184,0.15); color:#007db8;}
  .vendor-badge.juniper{background:rgba(132,189,0,0.15); color:#84bd00;}
  .vendor-badge.hp, .vendor-badge.hewlett{background:rgba(0,150,214,0.15); color:#0096d6;}
  .vendor-badge.unknown{background:rgba(148,163,184,0.12); color:var(--text-muted);}

  .version-text{
    font-family:monospace;
    font-size:12px;
    background: color-mix(in oklab, var(--accent) 8%, transparent);
    padding:4px 8px;
    border-radius:4px;
    white-space:nowrap;
  }

  .pagination{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:16px;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    margin-top:20px;
    gap:12px;
    flex-wrap:wrap;
  }
  .pagination .page-info{
    font-size:13px;
    color:var(--muted);
    font-weight:600;
  }
  .pagination .page-controls{
    display:flex;
    gap:8px;
  }
  .pagination .btn{
    padding:8px 16px;
    font-size:13px;
  }

  .empty-state{
    text-align:center;
    padding:60px 24px;
    color:var(--muted);
  }
  .empty-state svg{
    width:48px;
    height:48px;
    margin-bottom:16px;
    opacity:0.5;
  }
  .empty-state h3{
    margin:0 0 10px;
    font-family:'Instrument Sans', sans-serif;
    font-size:18px;
    color:var(--text);
  }
  .empty-state p{font-size:14px;}
  .empty-state a{color:var(--accent);}

  .selected-filters{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-bottom:16px;
  }
  .filter-tag{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 12px;
    background: color-mix(in oklab, var(--accent) 12%, transparent);
    border:1px solid color-mix(in oklab, var(--accent) 30%, transparent);
    border-radius:999px;
    font-size:12px;
    font-weight:500;
  }
  .filter-tag .tag-label{
    color:var(--muted);
    text-transform:uppercase;
    font-size:10px;
    letter-spacing:0.05em;
  }
  .filter-tag .tag-value{
    color:var(--accent);
    font-weight:600;
  }

  /* Version Search Box */
  .version-search-box{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
    margin-bottom:20px;
  }
  .version-search-box h3{
    margin:0 0 12px 0;
    font-size:14px;
    font-weight:600;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .version-search-box h3 svg{
    width:18px;
    height:18px;
    color:var(--accent);
  }
  .version-search-row{
    display:flex;
    gap:12px;
    align-items:flex-end;
    flex-wrap:wrap;
  }
  .version-search-row .search-field{
    flex:1;
    min-width:300px;
  }
  .version-search-row input{
    width:100%;
    padding:12px 16px;
    border-radius:8px;
    border:1px solid var(--border);
    background:var(--bg);
    color:var(--text);
    font-size:14px;
    font-family:monospace;
  }
  .version-search-row input:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 15%, transparent);
  }
  .version-search-row .btn{
    padding:12px 24px;
  }
  .search-hint{
    font-size:11px;
    color:var(--muted);
    margin-top:8px;
  }
  .search-hint code{
    background:var(--bg);
    padding:2px 6px;
    border-radius:4px;
    font-size:10px;
  }

  /* Hierarchy View */
  .hierarchy-panel{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
    margin-bottom:20px;
  }
  .hierarchy-panel h3{
    margin:0 0 16px 0;
    font-size:14px;
    font-weight:600;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .hierarchy-panel h3 svg{
    width:18px;
    height:18px;
    color:var(--accent);
  }
  .hierarchy-tree{
    font-size:13px;
  }
  .hierarchy-vendor{
    margin-bottom:12px;
  }
  .hierarchy-vendor-header{
    display:flex;
    align-items:center;
    gap:8px;
    padding:10px 12px;
    background: color-mix(in oklab, var(--accent) 6%, transparent);
    border:1px solid color-mix(in oklab, var(--accent) 15%, var(--border));
    border-radius:8px;
    cursor:pointer;
    transition: all 0.15s ease;
  }
  .hierarchy-vendor-header:hover{
    background: color-mix(in oklab, var(--accent) 12%, transparent);
  }
  .hierarchy-vendor-header .vendor-name{
    font-weight:600;
    flex:1;
  }
  .hierarchy-vendor-header .vendor-count{
    font-weight:700;
    color:var(--accent);
    font-family:'Instrument Sans', sans-serif;
  }
  .hierarchy-vendor-header .toggle-icon{
    width:16px;
    height:16px;
    transition: transform 0.2s ease;
    color:var(--muted);
  }
  .hierarchy-vendor.collapsed .toggle-icon{
    transform: rotate(-90deg);
  }
  .hierarchy-models{
    margin-left:20px;
    border-left:2px solid var(--border);
    padding-left:16px;
    margin-top:8px;
    overflow:hidden;
    transition: max-height 0.3s ease;
  }
  .hierarchy-vendor.collapsed .hierarchy-models{
    max-height:0 !important;
    margin-top:0;
    padding-top:0;
  }
  .hierarchy-model{
    margin-bottom:8px;
  }
  .hierarchy-model-header{
    display:flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    background:var(--bg);
    border-radius:6px;
    cursor:pointer;
    transition: all 0.15s ease;
  }
  .hierarchy-model-header:hover{
    background: color-mix(in oklab, var(--accent) 8%, var(--bg));
  }
  .hierarchy-model-header .model-name{
    font-weight:500;
    flex:1;
  }
  .hierarchy-model-header .model-count{
    font-weight:600;
    color:var(--accent);
    font-size:12px;
  }
  .hierarchy-versions{
    margin-left:16px;
    padding-left:12px;
    border-left:1px dashed var(--border);
    margin-top:6px;
    overflow:hidden;
    transition: max-height 0.3s ease;
  }
  .hierarchy-model.collapsed .hierarchy-versions{
    max-height:0 !important;
    margin-top:0;
  }
  .hierarchy-version{
    display:flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:4px;
    transition: all 0.15s ease;
    cursor:pointer;
  }
  .hierarchy-version:hover{
    background: color-mix(in oklab, var(--accent) 8%, transparent);
  }
  .hierarchy-version .version-name{
    font-family:monospace;
    font-size:12px;
    flex:1;
  }
  .hierarchy-version .version-count{
    font-weight:600;
    color:var(--accent);
    font-size:12px;
    min-width:40px;
    text-align:right;
  }
  .hierarchy-version .view-btn{
    font-size:10px;
    padding:3px 8px;
    background:var(--accent);
    color:#fff;
    border-radius:4px;
    text-decoration:none;
    opacity:0;
    transition: opacity 0.15s ease;
  }
  .hierarchy-version:hover .view-btn{
    opacity:1;
  }
  .hierarchy-empty{
    text-align:center;
    padding:24px;
    color:var(--muted);
    font-size:13px;
  }
  .hierarchy-toggle-all{
    display:flex;
    gap:8px;
    margin-bottom:12px;
  }
  .hierarchy-toggle-all button{
    font-size:11px;
    padding:6px 12px;
    background:var(--bg);
    border:1px solid var(--border);
    border-radius:6px;
    color:var(--text);
    cursor:pointer;
    transition: all 0.15s ease;
  }
  .hierarchy-toggle-all button:hover{
    border-color:var(--accent);
    background: color-mix(in oklab, var(--accent) 8%, var(--bg));
  }
</style>
{% endblock %}
{% block content %}
<nav class="breadcrumbs">
  <a href="{{ url_for('index') }}">Dashboard</a>
  <span class="breadcrumbs-separator">/</span>
  <a href="{{ url_for('solarwinds.solarwinds_nodes') }}">SolarWinds</a>
  <span class="breadcrumbs-separator">/</span>
  <span class="breadcrumbs-current">Inventory</span>
</nav>

<div class="nav-pills">
  <a href="{{ url_for('solarwinds.solarwinds_nodes') }}">Nodes</a>
  <a href="{{ url_for('solarwinds.solarwinds_inventory') }}" class="active">Inventory</a>
  <a href="{{ url_for('solarwinds.solarwinds_nodes_settings') }}">Settings</a>
</div>

<div class="page-header">
  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:20px; flex-wrap:wrap;">
    <div style="flex:1;">
      <h2>Hardware/Software Inventory</h2>
      <p>Analyze device inventory by vendor, model, and software version for CVE impact assessment. Use multi-select filters to find devices running specific software versions.</p>
    </div>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn" href="{{ url_for('solarwinds.solarwinds_inventory_export', **request.args) }}">
        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="margin-right:4px;">
          <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
        Export CSV
      </a>
      <a class="btn" href="{{ url_for('solarwinds.solarwinds_inventory_export_summary', **request.args) }}">
        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="margin-right:4px;">
          <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 0l-2 2a1 1 0 101.414 1.414L8 10.414l1.293 1.293a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>
        Export Summary
      </a>
      <a class="btn" href="{{ url_for('solarwinds.solarwinds_nodes_settings') }}">
        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="margin-right:4px;">
          <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"/>
        </svg>
        Settings
      </a>
    </div>
  </div>
</div>

<!-- Summary Charts -->
<div class="summary-grid">
  <div class="summary-card">
    <h3>
      <svg viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 01-1 1h-2a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z"/>
      </svg>
      Devices by Vendor
    </h3>
    <div class="bar-chart">
      {% for vendor, count in vendor_counts %}
      <div class="bar-item" onclick="addFilter('vendor', '{{ vendor }}')">
        <span class="bar-label" title="{{ vendor }}">{{ vendor }}</span>
        <div class="bar-track">
          <div class="bar-fill vendor-{{ vendor|lower|replace(' ', '')|truncate(10, true, '') }}" style="width:{{ (count / filtered_count * 100)|round(1) if filtered_count > 0 else 0 }}%"></div>
        </div>
        <span class="bar-count">{{ count }}</span>
      </div>
      {% else %}
      <p class="muted" style="font-size:13px;">No vendor data available</p>
      {% endfor %}
    </div>
  </div>

  <div class="summary-card">
    <h3>
      <svg viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z"/>
      </svg>
      Top Software Versions
    </h3>
    <div class="bar-chart">
      {% for version, count in version_counts %}
      <div class="bar-item" onclick="addFilter('version', '{{ version }}')">
        <span class="bar-label" title="{{ version }}">{{ version }}</span>
        <div class="bar-track">
          <div class="bar-fill" style="width:{{ (count / filtered_count * 100)|round(1) if filtered_count > 0 else 0 }}%"></div>
        </div>
        <span class="bar-count">{{ count }}</span>
      </div>
      {% else %}
      <p class="muted" style="font-size:13px;">No version data available</p>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Version Search Box -->
<form method="get" class="version-search-box" id="versionSearchForm">
  <h3>
    <svg viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
    </svg>
    Version Search (CVE Assessment)
  </h3>
  <div class="version-search-row">
    <div class="search-field">
      <input type="text" id="version_search" name="version_search"
             placeholder="Search versions: 15.*, IOS-XE 17.*, re:^16\.[3-9].*"
             value="{{ filters.version_search }}">
      <div class="search-hint">
        Supports: plain text, wildcards (<code>*</code>), or regex (<code>re:pattern</code>).
        Examples: <code>15.2*</code> matches 15.2.x, <code>re:^17\\.([3-9]|1[0-2])</code> for IOS-XE 17.3-17.12
      </div>
    </div>
    <!-- Preserve existing filters -->
    {% for v in filters.vendor %}<input type="hidden" name="vendor" value="{{ v }}">{% endfor %}
    {% for m in filters.model %}<input type="hidden" name="model" value="{{ m }}">{% endfor %}
    {% for v in filters.version %}<input type="hidden" name="version" value="{{ v }}">{% endfor %}
    {% if filters.search %}<input type="hidden" name="search" value="{{ filters.search }}">{% endif %}
    {% if filters.hw_version %}<input type="hidden" name="hw_version" value="{{ filters.hw_version }}">{% endif %}
    <button type="submit" class="btn primary">Search Versions</button>
    {% if filters.version_search %}
    <a href="{{ url_for('solarwinds.solarwinds_inventory', vendor=filters.vendor, model=filters.model, version=filters.version, search=filters.search, hw_version=filters.hw_version) }}" class="btn">Clear Search</a>
    {% endif %}
  </div>
</form>

<!-- Hierarchy View: Vendor → Model → Version -->
<div class="hierarchy-panel">
  <h3>
    <svg viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 6a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zm0 6a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z"/>
    </svg>
    Version Aggregation (Vendor &rarr; Model &rarr; Version)
  </h3>
  {% if hierarchy %}
  <div class="hierarchy-toggle-all">
    <button type="button" onclick="expandAllHierarchy()">Expand All</button>
    <button type="button" onclick="collapseAllHierarchy()">Collapse All</button>
  </div>
  <div class="hierarchy-tree">
    {% for vendor in hierarchy[:15] %}
    <div class="hierarchy-vendor collapsed" data-vendor="{{ vendor.name }}">
      <div class="hierarchy-vendor-header" onclick="toggleVendor(this.parentElement)">
        <svg class="toggle-icon" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
        <span class="vendor-name">{{ vendor.name }}</span>
        <span class="vendor-count">{{ vendor.count }} devices</span>
      </div>
      <div class="hierarchy-models" style="max-height:0;">
        {% for model in vendor.models[:20] %}
        <div class="hierarchy-model collapsed" data-model="{{ model.name }}">
          <div class="hierarchy-model-header" onclick="toggleModel(this.parentElement)">
            <svg class="toggle-icon" viewBox="0 0 20 20" fill="currentColor" style="width:14px;height:14px;">
              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
            <span class="model-name">{{ model.name }}</span>
            <span class="model-count">{{ model.count }}</span>
          </div>
          <div class="hierarchy-versions" style="max-height:0;">
            {% for version, count in model.versions[:15] %}
            <div class="hierarchy-version" onclick="filterByVersion('{{ vendor.name }}', '{{ model.name }}', '{{ version }}')">
              <span class="version-name">{{ version }}</span>
              <span class="version-count">{{ count }}</span>
              <span class="view-btn">View Devices</span>
            </div>
            {% endfor %}
            {% if model.versions|length > 15 %}
            <div class="hierarchy-version" style="color:var(--muted);cursor:default;">
              <span class="version-name">... and {{ model.versions|length - 15 }} more versions</span>
            </div>
            {% endif %}
          </div>
        </div>
        {% endfor %}
        {% if vendor.models|length > 20 %}
        <div style="padding:8px 10px;color:var(--muted);font-size:12px;">
          ... and {{ vendor.models|length - 20 }} more models
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
    {% if hierarchy|length > 15 %}
    <div style="text-align:center;padding:12px;color:var(--muted);font-size:12px;">
      Showing top 15 vendors of {{ hierarchy|length }} total. Use filters to narrow results.
    </div>
    {% endif %}
  </div>
  {% else %}
  <div class="hierarchy-empty">
    <p>No inventory data to display. Configure SolarWinds and sync nodes to see aggregated data.</p>
  </div>
  {% endif %}
</div>

<!-- Filter Panel -->
<form method="get" class="filter-panel" id="filterForm">
  <h3>
    <svg viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z"/>
    </svg>
    Filter Inventory
  </h3>

  {% if filters.vendor or filters.model or filters.version or filters.search or filters.hw_version or filters.version_search %}
  <div class="selected-filters">
    {% for v in filters.vendor %}
    <span class="filter-tag">
      <span class="tag-label">Vendor:</span>
      <span class="tag-value">{{ v }}</span>
    </span>
    {% endfor %}
    {% for m in filters.model %}
    <span class="filter-tag">
      <span class="tag-label">Model:</span>
      <span class="tag-value">{{ m }}</span>
    </span>
    {% endfor %}
    {% for v in filters.version %}
    <span class="filter-tag">
      <span class="tag-label">Version:</span>
      <span class="tag-value">{{ v }}</span>
    </span>
    {% endfor %}
    {% if filters.version_search %}
    <span class="filter-tag">
      <span class="tag-label">Ver Search:</span>
      <span class="tag-value">{{ filters.version_search }}</span>
    </span>
    {% endif %}
    {% if filters.search %}
    <span class="filter-tag">
      <span class="tag-label">Search:</span>
      <span class="tag-value">{{ filters.search }}</span>
    </span>
    {% endif %}
    {% if filters.hw_version %}
    <span class="filter-tag">
      <span class="tag-label">HW Ver:</span>
      <span class="tag-value">{{ filters.hw_version }}</span>
    </span>
    {% endif %}
  </div>
  {% endif %}

  <div class="filter-grid">
    <div class="filter-field">
      <label for="search">Search</label>
      <input type="text" id="search" name="search" placeholder="Hostname, IP, model, version..." value="{{ filters.search }}">
    </div>
    <div class="filter-field">
      <label for="vendor">Vendor (multi-select)</label>
      <select id="vendor" name="vendor" multiple>
        {% for v in vendor_options %}
        <option value="{{ v }}" {% if v in filters.vendor %}selected{% endif %}>{{ v }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-field">
      <label for="model">Model (multi-select)</label>
      <select id="model" name="model" multiple>
        {% for m in model_options %}
        <option value="{{ m }}" {% if m in filters.model %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-field">
      <label for="version">Software Version (multi-select)</label>
      <select id="version" name="version" multiple>
        {% for v in version_options %}
        <option value="{{ v }}" {% if v in filters.version %}selected{% endif %}>{{ v }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-field">
      <label for="hw_version">Hardware Version</label>
      <input type="text" id="hw_version" name="hw_version" placeholder="Filter hardware version..." value="{{ filters.hw_version }}">
    </div>
  </div>

  <div class="filter-actions">
    <button type="submit" class="btn primary">Apply Filters</button>
    {% if filters.vendor or filters.model or filters.version or filters.search or filters.hw_version or filters.version_search %}
    <a href="{{ url_for('solarwinds.solarwinds_inventory') }}" class="btn">Clear All</a>
    {% endif %}
    <span style="margin-left:auto; font-size:12px; color:var(--muted);">
      Hold Ctrl/Cmd to select multiple options
    </span>
  </div>
</form>

<!-- Stats Bar -->
<div class="stats-bar">
  <div class="stat">
    <svg viewBox="0 0 20 20" fill="currentColor">
      <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
    </svg>
    <span>Showing <span class="stat-value" id="visibleCount">{{ filtered_count }}</span> of <span class="stat-value">{{ total_count }}</span> devices</span>
  </div>
  <div class="stat" style="margin-left:auto; font-size:12px;">
    <svg viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"/>
    </svg>
    <span>Last sync: {{ settings.last_poll_ts or 'never' }}</span>
  </div>
</div>

<!-- Data Table -->
<div class="table-container">
  {% if nodes %}
  <table class="inv-table" id="inventoryTable">
    <thead>
      <tr>
        <th>Hostname</th>
        <th>IP Address</th>
        <th>Organization</th>
        <th>Vendor</th>
        <th>Model</th>
        <th>Software Version</th>
        <th>Hardware Version</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
  {% else %}
  <div class="empty-state">
    <svg viewBox="0 0 20 20" fill="currentColor">
      <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
    </svg>
    {% if filters.vendor or filters.model or filters.version or filters.search or filters.hw_version %}
    <h3>No Matching Devices</h3>
    <p>No devices match your filter criteria. <a href="{{ url_for('solarwinds.solarwinds_inventory') }}">Clear filters</a> to see all devices.</p>
    {% else %}
    <h3>No Inventory Data</h3>
    <p>No devices found. Configure SolarWinds and run a sync to populate inventory.</p>
    <a class="btn primary" href="{{ url_for('solarwinds.solarwinds_nodes_settings') }}" style="margin-top:16px;">Configure SolarWinds</a>
    {% endif %}
  </div>
  {% endif %}
</div>

{% if nodes %}
<div class="pagination" id="pagination"></div>
{% endif %}

<script>
(function(){
  var data = {{ nodes|tojson|safe }};
  var tbody = document.getElementById('tableBody');
  var pagination = document.getElementById('pagination');
  var countEl = document.getElementById('visibleCount');
  var PAGE_SIZE = 100;

  if (!tbody || !Array.isArray(data) || data.length === 0) return;

  var currentPage = 1;

  function escapeHtml(text) {
    if (!text) return '';
    var div = document.createElement('div');
    div.textContent = text;
    return div.textContent;
  }

  function getVendorClass(vendor) {
    if (!vendor) return 'unknown';
    var v = vendor.toLowerCase().replace(/\s+/g, '');
    if (v.indexOf('cisco') !== -1) return 'cisco';
    if (v.indexOf('dell') !== -1) return 'dell';
    if (v.indexOf('aruba') !== -1) return 'aruba';
    if (v.indexOf('juniper') !== -1) return 'juniper';
    if (v.indexOf('hewlett') !== -1 || v.indexOf('hp') !== -1) return 'hp';
    return 'unknown';
  }

  function createCell(text, isStrong, isCode, isVersion, className) {
    var td = document.createElement('td');
    var content = escapeHtml(text) || '—';
    if (isVersion && text) {
      var span = document.createElement('span');
      span.className = 'version-text';
      span.textContent = text;
      td.appendChild(span);
    } else if (isCode && text) {
      var code = document.createElement('code');
      code.style.fontSize = '12px';
      code.textContent = text;
      td.appendChild(code);
    } else if (isStrong) {
      var strong = document.createElement('strong');
      strong.textContent = content;
      td.appendChild(strong);
    } else if (className) {
      var span = document.createElement('span');
      span.className = className;
      span.textContent = text || 'Unknown';
      td.appendChild(span);
    } else {
      td.textContent = content;
    }
    return td;
  }

  function renderTable() {
    while (tbody.firstChild) {
      tbody.removeChild(tbody.firstChild);
    }
    var totalPages = Math.max(1, Math.ceil(data.length / PAGE_SIZE));
    if (currentPage > totalPages) currentPage = totalPages;

    var start = (currentPage - 1) * PAGE_SIZE;
    var pageData = data.slice(start, start + PAGE_SIZE);

    for (var i = 0; i < pageData.length; i++) {
      var node = pageData[i];
      var tr = document.createElement('tr');
      var vendorClass = 'vendor-badge ' + getVendorClass(node.vendor);

      tr.appendChild(createCell(node.caption, true, false, false, null));
      tr.appendChild(createCell(node.ip_address, false, true, false, null));
      tr.appendChild(createCell(node.organization, false, false, false, null));
      tr.appendChild(createCell(node.vendor, false, false, false, vendorClass));
      tr.appendChild(createCell(node.model, false, false, false, null));
      tr.appendChild(createCell(node.version, false, false, true, null));
      tr.appendChild(createCell(node.hardware_version, false, false, false, null));

      tbody.appendChild(tr);
    }

    renderPagination(totalPages);
  }

  function renderPagination(totalPages) {
    if (!pagination) return;
    while (pagination.firstChild) {
      pagination.removeChild(pagination.firstChild);
    }

    var info = document.createElement('span');
    info.className = 'page-info';
    var start = (currentPage - 1) * PAGE_SIZE + 1;
    var end = Math.min(currentPage * PAGE_SIZE, data.length);
    info.textContent = 'Showing ' + start + '-' + end + ' of ' + data.length + ' devices';

    var controls = document.createElement('div');
    controls.className = 'page-controls';

    function makeBtn(label, disabled, handler) {
      var btn = document.createElement('button');
      btn.className = 'btn';
      btn.type = 'button';
      btn.textContent = label;
      btn.disabled = disabled;
      btn.addEventListener('click', handler);
      return btn;
    }

    controls.appendChild(makeBtn('Previous', currentPage <= 1, function() {
      if (currentPage > 1) { currentPage--; renderTable(); }
    }));
    controls.appendChild(makeBtn('Next', currentPage >= totalPages, function() {
      if (currentPage < totalPages) { currentPage++; renderTable(); }
    }));

    pagination.appendChild(info);
    pagination.appendChild(controls);
  }

  renderTable();
})();

function addFilter(type, value) {
  var form = document.getElementById('filterForm');
  var select = document.getElementById(type);
  if (select && select.multiple) {
    for (var i = 0; i < select.options.length; i++) {
      if (select.options[i].value === value) {
        select.options[i].selected = true;
        break;
      }
    }
  }
  form.submit();
}

// Hierarchy view toggle functions
function toggleVendor(el) {
  el.classList.toggle('collapsed');
  var models = el.querySelector('.hierarchy-models');
  if (models) {
    if (el.classList.contains('collapsed')) {
      models.style.maxHeight = '0';
    } else {
      models.style.maxHeight = models.scrollHeight + 'px';
      // Also account for potential nested expanded content
      setTimeout(function() {
        models.style.maxHeight = models.scrollHeight + 'px';
      }, 50);
    }
  }
}

function toggleModel(el) {
  el.classList.toggle('collapsed');
  var versions = el.querySelector('.hierarchy-versions');
  if (versions) {
    if (el.classList.contains('collapsed')) {
      versions.style.maxHeight = '0';
    } else {
      versions.style.maxHeight = versions.scrollHeight + 'px';
    }
    // Update parent container height
    var parentModels = el.closest('.hierarchy-models');
    if (parentModels) {
      setTimeout(function() {
        parentModels.style.maxHeight = parentModels.scrollHeight + 'px';
      }, 50);
    }
  }
}

function expandAllHierarchy() {
  var vendors = document.querySelectorAll('.hierarchy-vendor');
  vendors.forEach(function(vendor) {
    vendor.classList.remove('collapsed');
    var models = vendor.querySelector('.hierarchy-models');
    if (models) {
      models.style.maxHeight = 'none';
    }
  });
  var modelDivs = document.querySelectorAll('.hierarchy-model');
  modelDivs.forEach(function(model) {
    model.classList.remove('collapsed');
    var versions = model.querySelector('.hierarchy-versions');
    if (versions) {
      versions.style.maxHeight = 'none';
    }
  });
}

function collapseAllHierarchy() {
  var vendors = document.querySelectorAll('.hierarchy-vendor');
  vendors.forEach(function(vendor) {
    vendor.classList.add('collapsed');
    var models = vendor.querySelector('.hierarchy-models');
    if (models) {
      models.style.maxHeight = '0';
    }
  });
  var modelDivs = document.querySelectorAll('.hierarchy-model');
  modelDivs.forEach(function(model) {
    model.classList.add('collapsed');
    var versions = model.querySelector('.hierarchy-versions');
    if (versions) {
      versions.style.maxHeight = '0';
    }
  });
}

function filterByVersion(vendor, model, version) {
  // Build URL with filters to show devices matching this specific combination
  var params = new URLSearchParams();
  params.append('vendor', vendor);
  params.append('model', model);
  params.append('version', version);
  window.location.href = '{{ url_for("solarwinds.solarwinds_inventory") }}?' + params.toString();
}
</script>
{% endblock %}
