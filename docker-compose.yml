# NOC Toolkit Docker Compose Configuration
# Run with: docker-compose up -d

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: noc-toolkit-app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-5000}:5000"
    environment:
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY}
      - NOC_ENCRYPTION_KEY=${NOC_ENCRYPTION_KEY}
      - NOC_ADMIN_PASSWORD=${NOC_ADMIN_PASSWORD:-}
      - NOC_TOOLKIT_DB_PATH=/app/data/noc_toolkit.db
      - NOC_TOOLKIT_DATA_DIR=/app/data
      - WLC_DASHBOARD_KEY=${WLC_DASHBOARD_KEY:-}
      - FLASK_ENV=${FLASK_ENV:-production}
    volumes:
      - app-data:/app/data
      - app-logs:/app/logs
      - app-tmp:/app/tmp
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - noc-network

  postgres:
    image: postgres:15-alpine
    container_name: noc-toolkit-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-noc_toolkit}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-noc_toolkit}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-noc_toolkit} -d ${POSTGRES_DB:-noc_toolkit}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - noc-network

volumes:
  app-data:
    name: noc-toolkit-data
  app-logs:
    name: noc-toolkit-logs
  app-tmp:
    name: noc-toolkit-tmp
  postgres-data:
    name: noc-toolkit-postgres

networks:
  noc-network:
    name: noc-toolkit-network
    driver: bridge
